<a link='https://blogs.msdn.microsoft.com/fcatae/2014/09/30/msdtc-internals/'>MSDTC Internals</a>
<blockquote>   <p><em>Essa semana me surpreendi com o </em><a href="https://www.sqlsaturday.com/325/eventhome.aspx"><em>SQL Saturday #325</em></a><em>. Fiquei tão empolgado que resolvi investir um tempo para escrever esse post. A escolha do tema foi através de uma <a href="https://twitter.com/DemetrioSQLDBA/status/516650881304231937">conversa</a> no twitter. Obrigado <a href="https://twitter.com/DemetrioSQLDBA">@DemetrioSQLDBA</a> e <a href="https://twitter.com/SQLInsane">@SQLInsane</a> pela sugestão.</em></p> </blockquote>  <p>Frequentemente associamos o SQL Server às operações transacionais. Todas as informações são consistentes graças ao Transaction Log.</p>  <p>Entretanto, existe um serviço nativo do Windows chamado Microsoft Distributed Transaction Coordinator (MSDTC). Esse serviço executa as transações utilizando o protocolo chamado 2-Phase Commit. Qualquer recurso pode participar de uma transação distribuída. Por exemplo:</p>  <ul>   <li>SQL Server (claro!)</li>    <li>Servidores Oracle</li>    <li>Filas IBM MQSeries</li>    <li>Componentes COM+</li> </ul>  <p>A arquitetura do MSDTC é composta por dois grandes componentes: Transaction Manager (TM) e Connection Manager (CM).</p>  <p>&#160;</p>  <h2>Transaction Manager</h2>  <p>O componente do Transaction Manager (TM) é responsável por implementar o protocolo 2-Phase Commit. Embora ninguém fale desse jeito, gosto de pensar que as fases são:</p>  <ol>   <li>Persistência de dados – TM garante que as informações estão gravadas em disco</li>    <li>Disponibilidade – O serviço do TM estará disponível para efetivar a modificação</li> </ol>  <p>Portanto, quando uma transação distribuída ocorre, todas as informações devem ser gravadas em seu respectivo storage em uma primeira fase. SQL Server armazena a informação no Transaction Log. Da mesma forma, imagino que o Oracle guarda os dados no Redo Log e o MQSeries armazena a mensagem em disco. Embora as informações estejam gravadas em log, elas ainda não estão disponíveis para a aplicação.</p>  <p>Durante a segunda fase, o MSDTC efetiva todas as transações. </p>  <ul>   <li><strong>Se qualquer recurso falhou na “fase 1 – persistência de dados”</strong>, então todas os recursos falham e fazem o ROLLBACK da informação. Parece estranho pensar que o SQL Server faz rollback do Transaction Log, mas é exatamente isso que ocorre no 2-Phase Commit.</li>    <li><strong>Se *TODOS* os recursos conseguiram gravar os dados em disco</strong>, então é declarada a efetivação dos dados (COMMIT). </li> </ul>  <p>Observamos que o principal objetivo do MSDTC é coordenar os recursos transacionais (SQL, Oracle, MQ) usando o conceito de COMMIT ou ROLLBACK. Aqui existe a curiosa situação da transação IN-DOUBT:</p>  <ul>   <li>Falhas durante a primeira fase causam o ROLLBACK</li>    <li>Falhas durante a segunda fase não afetam as transações, que já foram declaradas como COMMIT</li>    <li>Indisponibilidade de máquina na primeira fase tornam a transação IN-DOUBT – e a resolução é feita quando a máquina volta ao ar</li> </ul>  <p>&#160;</p>  <h2>Connection Manager</h2>  <p>Em geral, existe um Transaction Manager (TM) por máquina. O serviço do MSDTC utiliza o protocolo RPC para se manter conectado com os demais TM. </p>  <p>RPC é um protocolo antigo e complexo. Todas as máquinas devem disponibilizar o serviço do RPC Locator na porta TCP 135, além de alocar dinamicamente uma porta TCP aleatória. Isso sempre causa dor de cabeça na hora de configurar o firewall. Já cansei de recomendar o artigo abaixo.</p>  <blockquote>   <p><em>Configurando Microsoft coordenador de transações distribuídas (DTC) para trabalhar por meio de um firewall        <br /></em><a title="http://support2.microsoft.com/kb/250367" href="http://support2.microsoft.com/kb/250367"><em>http://support2.microsoft.com/kb/250367</em></a></p> </blockquote>  <p>Em geral, os problemas do MSDTC relacionados à conectividade podem ser facilmente diagnosticados com o <a href="http://download.microsoft.com/download/d/0/0/d00c8f6b-135d-4441-a97b-9de16a1935c1/dtcping.exe">DTCPing</a>.</p>  <p>&#160;</p>  <h1>MSDTC não suportado?</h1>  <p>Vou deixar como um desafio: você sabe por que o MSDTC não é suportado em um ambiente com Database Mirroring ou Availability Group? A explicação é similar ao motivo de não recomendarmos MSDTC local em instâncias clusterizadas.</p>
