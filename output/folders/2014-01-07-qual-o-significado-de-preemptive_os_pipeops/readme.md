<a link='https://blogs.msdn.microsoft.com/fcatae/2014/01/07/qual-o-significado-de-preemptive_os_pipeops/'>Qual o significado de PREEMPTIVE_OS_PIPEOPS?</a>
<p>Publiquei um post de um cenário na qual o comando KILL que não consegue matar o processo.</p>  <blockquote>   <p><a href="http://blogs.msdn.com/b/fcatae/archive/2014/01/06/desafio-comando-kill-demorado-infinito.aspx">Desafio: Comando KILL demorado (infinito)</a></p> </blockquote>  <p>Esse foi um desafio (fácil, pelo jeito). A resposta é usar uma ferramenta para matar o processo do NOTEPAD.EXE, seja através de script Powershell, usando o Task Manager ou o comando TASKKILL.</p>  <p>Alguns comentários interessantes:</p>  <ul>   <li>Luiz Mercante comentou sobre os processos filhos do SQL Server</li>    <li>Advaldo falou sobre usar o Process Explorer</li>    <li>Laerte e Leivio comentaram sobre o PREEMPTIVE_OS_PIPEOPS</li> </ul>  <p>Assim, deixo mostrar uma experiência bem interessante (esse é um ótimo DEMO para fazer com os amigos).</p>    <p>1) O primeiro passo é baixar o <a href="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx">Process Explorer</a> do site TechNet.</p>  <blockquote>   <p><a title="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx" href="http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx">http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx</a></p> </blockquote>  <p>2) Em seguida, rodamos o Process Explorer usando o modo elevado.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8686.image_5BC79DF2.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1205.image_thumb_592172F2.png" width="322" height="201" /></a></p> </blockquote>  <p>3) Agora procuramos o processo SQLSERVR.EXE na lista. Assim, observamos a cadeia de processo pai e filho.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8585.image_4AE58AB3.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0830.image_thumb_685A6C70.png" width="333" height="152" /></a></p> </blockquote>    <h1>Agora vamos a mágica!</h1>  <p>4. A comunicação entre processos é sempre feita através de um mecanismo de IPC (Inter Process Communication). Nesse caso, o SQL Server utiliza um objeto de Named Pipe. Imaginem o motivo disso…</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6165.image_2195F4C8.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5852.image_thumb_73AB32C0.png" width="500" height="252" /></a></p> </blockquote>  <p>5. Vamos investigar o comportamento do NOTEPAD.EXE. Ele possui dois Named Pipe (a figura abaixo é praticamente igual a anterior, mas note que estou observando o processo do Command Prompt).</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7450.image_6C225404.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/4375.image_thumb_104A3F45.png" width="501" height="253" /></a></p> </blockquote>  <blockquote>   <p>Programadores <em>C/C++</em>: esses objetos correspondem ao <em>stdin</em> e <em>stdout</em>.&#160; </p> </blockquote>  <p>6. Do ponto de vista do SQL Server, o comando xp_cmdshell espera pelos dados provenientes do Named Pipe que serão gerados pelo processo filho. Outra opção seria o fechamento da comunicação. A mágica é que o Process Explorer consegue forçar o fechamento de objetos!</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5707.image_21BD30CE.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1031.image_thumb_6AE2DC87.png" width="339" height="58" /></a></p> </blockquote>  <p>7. Sem matar o processo do NOTEPAD.EXE, conseguimos interromper a comunicação entre os processos. SQL Server. </p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5658.image_7A194554.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5025.image_thumb_69A0D459.png" width="396" height="171" /></a></p> </blockquote>  <p>Vamos a conclusão.</p>  <p>Matar o NOTEPAD é uma solução (e eu faria isso também). Porém, bastava apenas fechar o canal de comunicação entre os processos e tudo voltaria ao normal.</p>    <h1>Qual o significado de PREEMPTIVE_OS_PIPEOPS?</h1>  <blockquote>   <p>O comando <strong>xp_cmdshell </strong>cria um processo filho e abre uma comunicação usando os streams <em>stdin</em> e <em>stdout</em>, que correspondem a objetos de Named Pipe. Durante essa comunicação, o SQL Server sinaliza a espera pelo wait type <strong>PREEMPTIVE_OS_PIPEOPS</strong>. Portanto, isso é nada mais, nada menos, do que uma dica sobre qual atividade que está sendo realizada naquele exato momento.</p></blockquote>
