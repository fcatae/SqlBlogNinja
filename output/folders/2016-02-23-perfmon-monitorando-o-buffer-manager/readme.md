<a link='https://blogs.msdn.microsoft.com/fcatae/2016/02/23/perfmon-monitorando-o-buffer-manager/'>Perfmon: Monitorando o Buffer Manager</a>
<p>O gerenciador de memória de Buffer de dados, também conhecido por Data Cache ou Database Cache, fornece as melhores informações sobre a utilização de memória do banco de dados. </p>  <p>Inicialmente analisamos os contadores:</p>  <ul>   <li>Page life expectancy</li>    <li>Lazy writes/sec</li>    <li>Free list stalls/sec</li> <!--EndFragment--></ul>  <p>Segue aqui alguns exemplos de gráfico do Page Life Expectancy (PLE). Particularmente, gosto de utilizar validar se o PLE está acima de 5000 ao invés de usar o tradicional valor limite de 300. Nos casos abaixo, todos os servidores apresentam carga ao longo do dia, embora apenas o terceiro esteja com aparente falta de memória. </p>  <p><a href="images\8306.image_2A024A6D.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\0876.image_thumb_0FB0382E.png" width="644" height="165" /></a></p>  <p><a href="images\0741.image_5D5A4586.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\2021.image_thumb_2A0C6302.png" width="644" height="204" /></a></p>  <p><a href="images\2021.image_641DC092.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\6683.image_thumb_11353E12.png" width="644" height="204" /></a></p>  <p>Podemos complementar a análise olhando o contador Free List Stalls/sec, que deve ser sempre zero absoluto – parece que existe um novo Latch que deixa claro sua interferência, que se chama Lazy Writer Helper.</p>  <p>Em seguida, podemos olhar a distribuição de memória usando os contadores:</p>  <ul>   <li>Database pages</li>    <li>Free pages</li>    <li>Stolen pages</li>    <li>Target pages</li>    <li>Total pages</li> </ul>  <p>Os servidores apresentam: 1) distribuição constante e normal; 2) folga e sobra de memória; 3) alto consumo de memória não-buffer (stolen). Em nenhum dos gráficos temos uma situação que podemos chamar de crítica, que seria quando o Stolen Memory chega a 75% do total de memória (pressão interna) ou quando o Total Pages e Target Pages começam a diminuir ao longo do tempo (pressão externa).</p>  <p><a href="images\1346.image_thumb3_62DE4915.png"><img title="image_thumb[3]" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image_thumb[3]" src="images\8623.image_thumb3_thumb_4493921F.png" width="644" height="165" /></a></p>  <p><a href="images\7178.image_thumb5_3B3A5D9C.png"><img title="image_thumb[5]" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image_thumb[5]" src="images\1663.image_thumb5_thumb_0AA6DFE4.png" width="644" height="164" /></a></p>  <p><a href="images\1033.image_thumb4_15D2FADF.png"><img title="image_thumb[4]" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image_thumb[4]" src="images\0815.image_thumb4_thumb_6E9B425A.png" width="644" height="164" /></a></p>  <p>Por fim, confirmamos que as variações do PLE são causados por Table/Index Scan no servidor usando os contadores Page Reads/sec e Readahead pages/sec. Adicionalmente, você pode acompanhar o contador Page lookups/sec para ter uma ideia da carga.</p>  <ul>   <li>Page lookups/sec</li>    <li>Page reads/sec</li>    <li>Readahead pages/sec</li> </ul>  <p>Seguem os gráficos correspondentes: notamos que a quantidade de Reads (aleatório + sequencial) é praticamente igual a Readahead (sequencial). Assim, o primeiro servidor apresenta picos de utilização, que causam grandes variações no PLE . No segundo e terceiro servidor, está ocorrendo uma operação de Scan realizando a leitura de 10-30 mil págnas por segundo (equivalente a 80-240MB/seg!!!). </p>  <p><a href="images\3005.image_190A0429.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\5187.image_thumb_7D6808E3.png" width="644" height="165" /></a></p>  <p><a href="images\3414.image_2CB97E6E.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\2210.image_thumb_3302E5AD.png" width="644" height="204" /></a></p>  <p><a href="images\2158.image_394C4CEC.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\2022.image_thumb_617E85FE.png" width="644" height="204" /></a></p>  <p>Aqui conseguimos concluir:</p>  <ul>   <li>Servidor 1 possui memória suficiente para aguendar a carga. A variação do PLE ocorre por conta de picos de consumo (ver gráfico do readahead), mas não há indícios de falta de memória.</li>    <li>Servidor 2 possui memória de sobra (ver o gráfico de Free Memory) e recebe uma carga bastante pesada (ver gráfico de readahead)</li>    <li>Servidor 3 recebe uma carga semelhante ao Servidor 2 (ver gráfico de readahead), entretanto o PLE indica que o nível de memória está constantemente baixo. A distribuição de memória revela que grande parte está reservado como Stolen Memory (provavelmente são Memory Grants). A carga desse servidor é alta e falta memória.</li> </ul>  <p>Não há dúvida que o Performance Monitor é a melhor ferramenta para conduzir uma análise sobre a utilização de memória do SQL Server.</p>
