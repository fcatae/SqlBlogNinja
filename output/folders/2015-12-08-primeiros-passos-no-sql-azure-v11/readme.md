<a link='https://blogs.msdn.microsoft.com/fcatae/2015/12/08/primeiros-passos-no-sql-azure-v11/'>Primeiros passos no SQL Azure (v11)</a>
<p>Como havia comentado no post <a href="blogs.msdn.com/b/fcatae/archive/2015/10/08/sql-azure-tempdb.aspx">SQL Azure TempDB</a>, comecei a trabalhar com o SQL Azure. A primeira reação que tive foi que os bancos de dados TempDB, Model e MSDB sumiram. </p>  <p>Hoje quero compartilhar um pouco das outras surpresas que tive com o SQL Azure. Eu não sabia que existem diferentes versões no Azure (11 e 12) e isso faz muita diferença.</p>  <h3>Versão 11 ou 12</h3>  <p>Como saber qual a versão do SQL Server? </p>  <p>Comecei rodando o comando <strong>xp_msver</strong> para buscar a versão, mas retornou o erro:</p>  <blockquote>   <p><font color="#ff0000" face="Consolas">Msg 2812, Level 16, State 62, Line 10       <br />Could not find stored procedure 'xp_msver'.</font></p> </blockquote>  <p>Então a solução foi rodar <strong>SELECT @@version</strong>.</p>  <blockquote>   <p><font face="Consolas"><strong>Microsoft SQL Azure (RTM) - 11.0.9231.178          <br />&#160;&#160;&#160; Oct 22 2015 12:39:03           <br />&#160;&#160;&#160; Copyright (c) Microsoft Corporation</strong></font></p> </blockquote>  <p>Hoje estarei trabalhando com o <strong>SQL Azure versão 11</strong> e isso é algo muito importante. Muitas coisas não são suportadas pelo SQL 11. Se você é um desenvolvedor, provavelmente notará poucas coisas diferentes. Entretanto, se você for um DBA e está acostumado com o SQL Server tradicional (2000, 2005, 2008, 2012, 2014), então terá inúmeras surpresas.</p>  <h3>Documentação</h3>  <p>Onde está o SQL Books Online (BOL)? Para mim, BOL é a bíblia do SQL e tem toda a documentação necessária para meu dia a dia. Gosto de fazer o download e deixar instalado na minha máquina, não sendo necessário me conectar online para tirar dúvidas. Mas quando vamos para o Azure, cadê o BOL relacionado?</p>  <blockquote>   <p>Books Online     <br /><a title="http://technet.microsoft.com/en-us/library/ms130214.aspx" href="http://technet.microsoft.com/en-us/library/ms130214.aspx">http://technet.microsoft.com/en-us/library/ms130214.aspx</a></p> </blockquote>  <p>A melhor documentação que encontrei foi o Azure Documentation, mas é bem diferente do BOL.</p>  <blockquote>   <p>Azure documentation     <br /><a title="https://azure.microsoft.com/pt-br/documentation/articles/sql-database-technical-overview/" href="https://azure.microsoft.com/pt-br/documentation/articles/sql-database-technical-overview/">https://azure.microsoft.com/pt-br/documentation/articles/sql-database-technical-overview/</a></p> </blockquote>  <p>Isso não deve ser um problema, pois, na teoria, os comandos tradicionais do SQL funcionam no Azure normalmente.</p>  <h3>Comandos Suportados</h3>  <p>Na teoria, os comandos tradicionais do SQL funcionam no Azure normalmente. <strong>Na prática, quase nada funciona igual ao SQL Server tradicional. </strong></p>  <p>Deixo fazer algumas considerações sobre o cenário:</p>  <ul>   <li>SQL Azure v11</li>    <li>Comandos administrativos</li> </ul>  <p>Meu dia começou com os seguintes comandos:</p>  <h5>1. Escolhendo o banco de dados</h5>  <p>Não existe o comando <strong>USE &lt;database&gt;</strong>.</p>  <blockquote>   <p><font color="#ff0000" face="Consolas">Msg 40508, Level 16, State 1, Line 4       <br />USE statement is not supported to switch between databases. Use a new connection to connect to a different Database.</font></p> </blockquote>  <p>A forma mais fácil é mudar o contexto de banco de dados usando a interface gráfica. Isso força uma nova conexão com o banco de dados. </p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/3438.image_59734EC9.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2642.image_thumb_11C2376B.png" width="243" height="111" /></a></p> </blockquote>  <p>O efeito colateral é que a informação sobre o Session ID nunca aparece corretamente. É meio estranho explicar, mas tenho certeza que isso acaba confundindo muita gente (demorei muito tempo para perceber isso).</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8750.image_6E2B2A74.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/3000.image_thumb_0FACEAB5.png" width="231" height="82" /></a></p> </blockquote>  <p>O ideal é registrar uma conexão e adicionar “Connection Properties” com o nome do banco de dados.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2526.image_4B7A6440.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5280.image_thumb_431BB04B.png" width="503" height="299" /></a></p> </blockquote>  <p>&#160;</p>  <h5>2. Quem está conectado no banco?</h5>  <p>Eu raramente uso o comando <strong>sp_who</strong>. Entretanto, é curioso saber que esse comando não existe no SQL Azure v11. Também não existe <strong>sp_who2</strong>, nem <strong>sysprocesses</strong>. </p>  <p>A solução é fácil: basta usar as DMV’s.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/4341.image_0B01E488.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8203.image_thumb_09BFDC5A.png" width="293" height="68" /></a></p> </blockquote>  <p>&#160;</p>  <h5>3. Qual foi o comando enviado? </h5>  <p>Conhecendo os processos ativos no servidor, normalmente quero identificar o comando em execução. Para isso usamos o <strong>DBCC INPUTBUFFER </strong>para mostrar o conteúdo do último pacote de rede recebido, ou seja, ele contém a informação sobre o que está rodando na máquina. Mas esse é mais um comando não suportado no SQL Azure v11.</p>  <p>Assim, a solução é codificar usando a DMF chamada <strong>sys.dm_exec_sql_text</strong>.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2018.image_3260D912.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7220.image_thumb_25F5469A.png" width="380" height="39" /></a></p> </blockquote>  <p>Uma das vantagens de usar a DMF ao invés do DBCC é a possibilidade de usar dentro de SELECT.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1033.image_0BB76E27.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8321.image_thumb_091F23FF.png" width="658" height="150" /></a></p> </blockquote>  <p>&#160;</p>  <h5>4. Qual o espaço usado pelo banco de dados?</h5>  <p>Essa é uma informação fundamental no Azure, pois sempre queremos saber a espaço usado pelo banco de dados. A surpresa é que o clássico <strong>sp_spaceused </strong>não funciona. Essa procedure depende da <strong>sysindexes</strong>, que também não existe no SQL Azure v11.</p>                  <p>O melhor caminho é usar a DMV <strong>sys.dm_db_partition_stats</strong> para agregar o número de páginas usadas e reservadas.</p>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7870.image_6BF8BA4D.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/3225.image_thumb_27DCFE56.png" width="344" height="191" /></a></p> </blockquote>  <p>Por questão de métrica, calculamos o espaço do banco de dados como <strong>351159 x 8kb = 2743mb</strong>.</p>  <p>&#160;</p>  <h3>Conclusão</h3>  <p>Ainda estou começando a trabalhar com o SQL Azure e já notei muitas diferenças. Entretanto, essas diferenças não são tão perceptíveis do ponto de vista de desenvolvedor (<strong>comandos DML</strong>) ou na versão do <strong>SQL Azure v12</strong>. </p>
