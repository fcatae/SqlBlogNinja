<a link='https://blogs.msdn.microsoft.com/fcatae/2010/03/02/problema-the-system-detected-a-possible-attempt-to-compromise-security-parte-1/'>Problema: The system detected a possible attempt to compromise security (Parte 1)</a>
<p>Hoje me deparei com um problema bastante interessante em um servidor SQL e gostaria de compartilhar: o servidor retornava erro ao rodar a stored procedure <font face="Courier New">sp_readerrorlog.</font></p>  <blockquote>   <p><font face="Courier New">Msg 22004, Level 16, State 1, Line 0        <br />Failed to open loopback connection. Please see event log for more information.         <br />Msg 22004, Level 16, State 1, Line 0         <br />error log location not found</font></p> </blockquote>  <p>Consultando o Event Log, encontrava-se a seguinte mensagem de erro:</p>  <blockquote>   <p><font face="Courier New">Severity: 16 Error:-2146892976, OS: -2146892976 [Microsoft][SQL Server Native Client 10.0]SQL Server Network Interfaces: The system detected a possible attempt to compromise security.&#160; Please ensure that you can contact the server that authenticated you.</font></p> </blockquote>  <p>Nesse momento, o que fazer?</p>  <p>&#160;</p>  <h1></h1>  <h3>Decifrando o Código do Erro</h3>  <p>Note que a mensagem de erro do Sistema Operacional é um número negativo (-2146892976). O seu significado está escondido na representação hexadecimal.</p>  <p>O primeiro passo é converter o número –2146892976, que corresponde a 0x80090350 em hexadecimal. A partir daqui fica mais fácil procurar pelo código de erro (<a title="http://www.bing.com/search?q=0x80090350" href="http://www.bing.com/search?q=0x80090350">http://www.bing.com/search?q=0x80090350</a>) e encontrar a correspondência por SEC_E_DOWNGRADE_DETECTED.</p>  <p>&#160;</p>  <h3>Identificando a Origem do Erro</h3>  <p>Após a descoberta do erro SEC_E_DOWNGRADE_DETECTED, o próximo passo é isolar qual componente está relacionado com o problema. Basta analisar com calma as mensagens de erro e a resposta aparecerá.</p>  <blockquote>   <p><font face="Courier New">Msg 22004, Level 16, State 1, Line 0        <br />Failed to open <strong><font color="#ff0000">loopback connection</font></strong>. Please see event log for more information.         <br /></font></p>    <p><font face="Courier New">Severity: 16 Error:-2146892976, OS: -2146892976 [Microsoft][<strong><font color="#ff0000">SQL Server Native Client 10.0</font></strong>]SQL Server Network Interfaces: The system detected a possible attempt to compromise security.&#160; Please ensure that you can contact the server that authenticated you.</font></p> </blockquote>  <p>Captou? Ao executar a procedure sp_readerrorlog, houve a tentativa de abrir uma conexão com o próprio servidor (loopback connection) usando o provider SQL Server Native Client. Essa abertura de conexão falhou, retornando o erro 0x80090350.</p>  <p>O erro ocorreu durante a abertura de uma nova conexão. Por incrível que pareça, houve um erro na autenticação dentro do próprio servidor!</p>  <p>&#160;</p>  <h3>Falha de Autenticação</h3>  <p>A sequência dos fatos foi assim: </p>  <ul>   <li>DBA chama a stored procedure sp_readerrorlog </li>    <li>A procedure inicia uma abertura de um loopback connection </li>    <li>Durante o processo de autenticação, ocorre o erro SEC_E_DOWNGRADE_DETECTED </li> </ul>  <p>Seria possível ocorrer uma falha de autenticação dentro do próprio servidor? Refiz essa pergunta a colegas que são mestres no assunto e recebi a resposta:</p>  <blockquote>   <p><em>SEC_E_DOWNGRADE_DETECTED means that Kerberos failed with an unexpected error, and will not fall back to NTLM, common causes for this one: #1 domain controller cannot be found? (kerberos UDP?) or fragmentation issues (move to kerberos over TCP), so answering your question: yes could be a transient condition, but if happens regularly, netmon traces will be next step (kerberos logging might be helpful too)</em></p> </blockquote>  <p>A resposta é SIM, falha de autenticação pode ocorrer. No nosso caso, houve uma falha do Kerberos que causou esse tipo de comportamento. </p>  <p>&#160;</p>  <h3>Resolução do Erro</h3>  <p>Após poucos minutos, o problema desapareceu. Mas caso continuasse, o próximo passo seria investigar a comunicação com o Domain Controller usando o Network Monitor (ou ferramentas semelhantes para captura de pacotes de rede). </p>  <p>Esse problema foi ocasionado por um fator externo ao SQL Server.</p>  <p>&#160;</p>  <h3>Loopback Connection</h3>  <p>Por que o comando sp_readerrorlog precisaria abrir uma conexão loopback? Segue uma captura do Profiler com a resposta:</p>  <p><a href="images\image_2.png"><img style="border-right-width: 0px;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px" title="image" border="0" alt="image" src="images\image_thumb.png" width="547" height="57" /></a></p>
