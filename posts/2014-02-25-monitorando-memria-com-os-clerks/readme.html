<a link='https://blogs.msdn.microsoft.com/fcatae/2014/02/25/monitorando-memria-com-os-clerks/'>Monitorando Memória com os Clerks</a>
<p>No último <a href="http://blogs.msdn.com/b/fcatae/archive/2014/02/18/sp-xml-preparedocument-leak.aspx">post</a>, comentei sobre um erro relacionado à falta de memória no servidor SQL Server. Essa era a mensagem de erro:</p>  <blockquote>   <p><font color="#ff0000">Msg 6624, Level 16, State 7, Procedure sp_xml_preparedocument, Line 1        <br />XML document could not be created because server memory is low. Use sp_xml_removedocument to release XML documents.</font></p> </blockquote>  <p>Como próximo passo, minha sugestão foi investigar as sessões do servidor.</p>  <blockquote>   <p><strong>select session_id, memory_usage from sys.dm_exec_sessions        <br />where status = 'sleeping' and is_user_process = 1</strong></p> </blockquote>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2538.image_22AA8135.png"><img title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/4213.image_thumb_5D91B3FE.png" width="191" height="84" /></a></p> </blockquote>  <p>Assim, suspeitamos que a sessão 56 era culpada porque estava alocando 3080 páginas de 8Kb alocadas (24MB).</p>    <h1>Algo Estranho!</h1>  <p>Repetindo:</p>  <blockquote>   <p><em>“… suspeitamos que a sessão 56 era culpada porque estava alocando 3080 páginas de 8Kb alocadas (24MB)”</em></p> </blockquote>  <p>Esse parece um comportamento diferente…</p>  <blockquote>   <p><strong>Como que 24MB pode afetar causar falta de memória em um servidor com GB de memória?</strong></p> </blockquote>  <p>Algo estranho…</p>    <h1>Monitorando Memória</h1>  <p>Monitorar o consumo de memória usando a <strong>sys.dm_exec_sessions</strong> não é um método confiável. Essa DMV apresenta toda a memória consumida de forma exclusiva por uma sessão. A palavra “exclusiva” é chave no entendimento, porque isso significa que parte da memória não é considerada. Na realidade, a maior parte da memória é compartilhada. Por exemplo:</p>  <ul>   <li>Buffer Pool</li>    <li>Procedure Cache</li>    <li>Security Token Cache</li>    <li>Pools de Memória</li>    <li>Caches em geral</li> </ul>  <p>A forma correta é acompanhar o consumo de memória é utilizar os <strong>Memory Clerks</strong>.</p>  <blockquote>   <p>select * FROM sys.dm_os_memory_clerks</p> </blockquote>  <blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0410.image_thumb3_4BE9583B.png"><img title="image_thumb[3]" style="margin: 0px;border: 0px currentcolor" border="0" alt="image_thumb[3]" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8171.image_thumb3_thumb_1268D8F5.png" width="506" height="60" /></a></p> </blockquote>  <p>Aqui descobrimos que o problema está relacionado com o MEMORYCLERK_SQLGENERAL (normalmente associado ao compilador). </p>  <p>No próximo post, vamos abordar o MemObj – esse é o subcomponente do Memory Clerk. Vamos concluir com 100% de certeza que o problema está relacionado com os documentos XML.</p>
