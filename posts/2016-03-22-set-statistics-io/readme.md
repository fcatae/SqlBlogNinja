<a link='https://blogs.msdn.microsoft.com/fcatae/2016/03/22/set-statistics-io/'>SET STATISTICS IO</a>
<p>H&aacute; 20 anos quando comecei a estudar banco de dados, imaginava que o SQL era uma caixa-preta. Bastava inserir os dados e n&atilde;o precisaria me preocupar mais. Eu era um desenvolvedor sem conhecimento de banco de dados.<p>Para relembrar esse cen&aacute;rio, vou criar um banco de dados chamado LOJADB usando um pendrive (meu storage de 8GB).</p><blockquote>   <p><a href="images\3718.image_68B8C60F.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\7317.image_thumb_05C40589.png" width="244" height="153"></a></p> </blockquote><p>Usei um script simples com o &uacute;nico cuidado de deixar o espa&ccedil;o pr&eacute;-alocado e sem Auto-Growth para evitar surpresas nos testes.</p><blockquote>   <p><a href="images\3122.image_4E114B58.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\7750.image_thumb_1E56338A.png" width="575" height="139"></a></p> </blockquote><p>Nesse banco de dados, havia uma tabela de cadastro de clientes. Simplificando, seria algo assim:</p><blockquote>   <p><a href="images\5355.image_5DB3E71A.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\4456.image_thumb_72393698.png" width="196" height="106"></a></p> </blockquote><p>Voltando ao passado, comecei a inserir os dados no banco de dados. Era uma rotina aparentemente simples, mas demorava demais. A rotina levou cerca de 85 segundos para completar e inserir 10.000 registros &ndash; dividindo, d&aacute; 117 linhas por segundo. Na &eacute;poca isso chamou minha aten&ccedil;&atilde;o, pois imaginava que tudo no banco de dados fosse r&aacute;pido!</p><blockquote>   <p><a href="images\8204.image_7475BF54.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\6237.image_thumb_16CD54CE.png" width="404" height="243"></a></p> </blockquote><p>Comecei a executar alguns comandos e eles rodavam imediatamente!</p><blockquote>   <p><a href="images\4152.image_04185B17.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\4011.image_thumb_6AB057DC.png" width="279" height="44"></a></p> </blockquote><p>Em seguida fazia consulta de cliente e o resultado era instant&acirc;neo!</p><blockquote>   <p><a href="images\2451.image_740C1D10.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\8233.image_thumb_45B29763.png" width="362" height="50"></a></p> </blockquote><p>Essa foi minha primeira experi&ecirc;ncia com banco de dados: aparentemente as inser&ccedil;&otilde;es eram lentas, mas as consultas eram r&aacute;pidas. </p><p>&nbsp;</p><h3>SET STATISTICS</h3><p>Se voc&ecirc; j&aacute; foi desenvolvedor e vivenciou essa situa&ccedil;&atilde;o, ent&atilde;o preste aten&ccedil;&atilde;o ao comando SET STATISTICS. Esse foi o comando que abriu os meus olhos para entender como que um banco de dados funciona.</p><p>Primeiro vamos rodar o comando <strong>SET STATISTICS TIME</strong>.</p><blockquote>   <p><strong>SET STATISTICS TIME</strong>      <br><a title="https://msdn.microsoft.com/en-us/library/ms190287.aspx" href="https://msdn.microsoft.com/en-us/library/ms190287.aspx">https://msdn.microsoft.com/en-us/library/ms190287.aspx</a></p> </blockquote><blockquote>   <p><a href="images\6761.image_680A2CDC.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\5852.image_thumb_75703FE2.png" width="361" height="240"></a></p> </blockquote><p>O resultado do SET STATISTICS TIME mostra que a execu&ccedil;&atilde;o durou apenas 1ms, que &eacute; um resultado excelente!</p><p>Em seguida, rodei o comando <strong>SET STATISTICS IO</strong>.</p><blockquote>   <p><strong>SET STATISTICS IO       <br></strong><a title="https://msdn.microsoft.com/en-us/library/ms184361.aspx" href="https://msdn.microsoft.com/en-us/library/ms184361.aspx">https://msdn.microsoft.com/en-us/library/ms184361.aspx</a></p> </blockquote><p><a href="images\4863.image_77ACC89E.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\6888.image_thumb_1A045E18.png" width="805" height="164"></a></p><p>Isso me surpreendeu, pois n&atilde;o imaginava ver 1257 logical reads (parece um valor alto?). Fiquei curioso para entender o significado de cada um dos valores.</p><ul>   <li><strong>Scan count</strong>: N&uacute;mero de scan em tabelas</li>    <li><strong>Logical reads</strong>: Quantidade de p&aacute;ginas lidas (mem&oacute;ria ou disco)</li>    <li><strong>Physical reads</strong>: Quantidade de p&aacute;ginas lidas do disco</li>    <li><strong>Read-ahead reads</strong>: Quantidade de p&aacute;ginas lidas com prefetch </li>    <li><strong>Lob logical reads, lob physical reads, lob read-ahead reads</strong>: Contador de acesso aos large object (ex: TEXT) &ndash; desconsidere, por enquanto.</li> </ul><p>As consultas no banco de dados eram feitas todas em mem&oacute;ria sem a necessidade de ir ao disco. Por isso, repeti os testes com SET STATISTICS TIME e IO, mas antes rodei o comando DBCC DROPCLEANBUFFERS. Isso eliminaria o cache em mem&oacute;ria e for&ccedil;aria o acesso ao disco.</p><p><a href="images\4428.image_0E026DE4.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\7444.image_thumb_79137C21.png" width="681" height="296"></a></p><p>Nesse cen&aacute;rio, a consulta demorou 369ms. Executando o comando novamente sem limpar o cache:</p><p><a href="images\3568.image_4F3307EC.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\2502.image_thumb_439D4AAD.png" width="659" height="134"></a></p><p>O tempo voltava para 1ms como esperado.</p><h3>Conclus&atilde;o</h3><p>Surpresa? Espero que n&atilde;o. Trabalhar com dados em cache &eacute; muito mais r&aacute;pido.</p><p>Termino esse artigo relembrando que o disco &eacute; o principal recurso do SQL Server. Eu poderia perder muito tempo fazendo otimiza&ccedil;&otilde;es com base no SET STATISTICS TIME ao inv&eacute;s de usar o STATISTICS IO. Monitore o disco. Priorize o disco. Minha dica &eacute; que, se voc&ecirc; n&atilde;o conhece o SET STATISTICS IO, ent&atilde;o invista parte do tempo para entender esse comando. Ele &eacute; uma das melhores ferramentas de aprendizado.</p><p>Nota: Voc&ecirc; notou que um dos resultados do SET STATISTICS IO retornou 1257 logical reads e 823 read-aheads? N&atilde;o deveriam ser iguais? No pr&oacute;ximo post vamos explorar melhor o comando DBCC DROPCLEANBUFFERS e explicar esse comportamento. </p></p>

