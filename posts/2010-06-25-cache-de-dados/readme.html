<a link='https://blogs.msdn.microsoft.com/fcatae/2010/06/25/cache-de-dados/'>Cache de Dados</a>
<p>&lt;Continuando o artigo <a href="http://blogs.msdn.com/b/fcatae/archive/2010/06/16/monitorando-a-mem-243-ria-do-sql-server.aspx" target="_blank">Monitorando a memoria do SQL Server</a>&gt;</p>  <p>Antes de entender como o SQL Server gerencia seus recursos, vamos discutir uma questão relacionada ao papel da memória no servidor:</p>  <blockquote>   <p><strong>Qual a principal função da memória em um servidor de banco de dados?</strong></p> </blockquote>  <blockquote>   <p><em>Resp: A memória é usada para fazer cache de dados.</em></p> </blockquote>  <p>Essa área de cache é denominada Data Cache ou Buffer Pool.</p>  <p>&#160;</p>  <p><strong>Buffer Pool</strong></p>  <p>Esse é um dos componentes chaves para compreender como monitorar a memória do servidor. É o <strong>Buffer Pool </strong>que define quanto de memória será utilizada pelo SQL Server. O objetivo dele é usar o máximo de memória possível sem afetar a performance do Sistema Operacional. Em outras palavras, há um balanceamento de memória entre o SQL Server e o Sistema Operacional.</p>  <blockquote>   <p><em>Exemplo: Se eu tivesse um servidor com 64GB de memória RAM, esperaria que quase sua totalidade fosse utilizada para fazer cache de dados.</em> </p> </blockquote>  <p>SQL Server tem um único objetivo: utilizar o máximo de memória disponível no servidor, desde que o Sistema Operacional esteja tranquilo.</p>  <blockquote>   <p><em>Exemplo: No SQL Server 2000 rodando com Windows 2000, o gerenciamento de memória era feito da seguinte forma: SQL Server alocava toda a memória RAM e deixava o Sistema Operacional com <u>exatamente</u> 4MB (WOW! A primeira vez que li isso, quase cai da cadeira). Caso algum aplicativo precisasse de memória, começaria alocando parte dos 4MB, baixando a quantidade de memória livre para 3MB, 2MB,…. Durante esse mesmo período, o SQL Server detectava a diminuiçào de memória e devolveria parte da memória para o Windows. O objetivo era manter exatamente 4MB de memória livre.</em></p> </blockquote>  <p>A partir do Windows 2003, houve uma mudança na forma da quantidade de memória usada. SQL Server 2000/2005/2008 recebem notificações do próprio Sistema Operacional sobre o status da memória livre. Isso significa que o SQL Server aloca o máximo de memória para o Buffer Pool até o momento que chega uma notificação falando que a “memória do Sistema Operacional está baixa”. </p>  <p>(Nota: Essa notificação fica registrada na DMV sys.dm_os_ring_buffer disponível a partir do SQL 2005)</p>  <p>Outra coisa interessante aqui: quando falamos de aumento no uso de memória, estamos falando sobre o tamanho do Buffer Pool. A forma mais fácil de acompanhar esse crescimento é através da ferramenta Performance Monitor, através do contador:</p>  <ul>   <li>SQL Server Buffer manager: Total Pages</li> </ul>  <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8475.image_4.png"><img style="border-bottom: 0px;border-left: 0px;float: none;margin-left: auto;border-top: 0px;margin-right: auto;border-right: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0167.image_thumb_1.png" width="282" height="201" /></a> </p>  <p>Outra forma de acompanhar o tamanho do Buffer Pool é através da DMV sys.dm_os_sys_info e do comando DBCC MEMORYSTATUS.</p>  <blockquote>   <pre class="code"><span style="color: blue">SELECT </span>bpool_committed <span style="color: blue">FROM </span><span style="color: green">sys</span><span style="color: gray">.</span><span style="color: green">dm_os_sys_info</span></pre>
</blockquote>
<a href="http://11011.net/software/vspaste"></a>

<blockquote>
  <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6431.image_6.png"><img style="border-bottom: 0px;border-left: 0px;border-top: 0px;border-right: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7026.image_thumb_2.png" width="132" height="39" /></a> </p>
</blockquote>

<p>O comando DBCC MEMORYSTATUS está disponível desde o SQL 2000.</p>

<blockquote>
  <pre class="code"><span style="color: blue">DBCC </span>MEMORYSTATUS</pre>
</blockquote>
<a href="http://11011.net/software/vspaste"></a>

<blockquote>
  <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/3223.image_10.png"><img style="border-bottom: 0px;border-left: 0px;float: none;margin-left: auto;border-top: 0px;margin-right: auto;border-right: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0488.image_thumb_4.png" width="289" height="213" /></a> </p>
</blockquote>

<p>Foram 3 formas diferentes de obter o tamanho de 15520 páginas para o Buffer Pool. Considerando que cada página tem 8kb, então o meu SQL Server está usando aproximadamente 121MB para cache de dados (Data Cache).</p>

<p>No próximo post, comentarei sobre o evento de crescimento e diminuição do Buffer Pool, e como que eles estão relacionados com o contador chamado de Target Pages.</p>
