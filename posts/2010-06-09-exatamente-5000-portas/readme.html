<a link='https://blogs.msdn.microsoft.com/fcatae/2010/06/09/exatamente-5000-portas/'>Exatamente 5000 portas!</a>
<p>Essa foi uma situação curiosa. Realizamos um teste de stress para validar a carga de um servidor SQL Server e, para nossa surpresa,&#160; deparamos com erros “<em>SQL Server Does Not Exist Or Access Denied</em>”. Usando o NETSTAT, observamos que havia um limite de número de portas aberta, chegando até a porta 5000, no máximo.</p>  <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0647.image_2.png"><img style="border-right-width: 0px;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px" title="image" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1157.image_thumb.png" width="399" height="202" /></a></p>  <p>A questão é por que o limite da porta 5000 e não 5001, 5002, 5003 ou 5004?</p>  <p>Encontramos a explicação ninja! O limite está relacionado com as “portas efêmeras”, que estabelece o intervalo 1025-5000 para conexões TCP/IP. O diagnóstico pode ser feito com o auxílio da ferramenta NETSTAT, como mostra o artigo <a href="http://msdn.microsoft.com/en-us/library/aa560610(BTS.20).aspx" target="_blank">Avoiding TCP/IP Port Exhaustion</a>.</p>  <p>Felizmente o limite da porta 5000 pode ser aumentado para o máximo de 65534 através de uma chave no registry:</p>  <p>[HKLM\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]</p>  <blockquote>   <p>Parâmetro: MaxUserPort     <br />Tipo: DWORD      <br />Valor: 65534</p> </blockquote>  <p><strong>Esse parâmetro deve ser avaliado nas máquinas clientes (servidores de aplicação), não sendo necessário alterar a configuração no servidor SQL.</strong></p>  <p>Mensagens de erro “<em>SQL Server Does Not Exist Or Access Denied</em>” estão normalmente associados a configuração da aplicação cliente. </p>  <p>&#160;</p>  <p><strong><font size="3">Windows Vista</font></strong></p>  <p>Essa semana acabei de encontrar um problema de conexão a partir de uma estação Windows Vista. Não tem nenhuma relação com as portas efêmeras, mas está relacionado à configuração de firewall. Mais informações estão documentadas no <a href="http://support.microsoft.com/kb/944390" target="_blank">artigo KB944390</a>. </p>  <p>&#160;</p>  <p><strong><font size="3">Referência</font></strong></p>  <blockquote>Avoiding TCP/IP Port Exhaustion   <br /><a title="http://msdn.microsoft.com/en-us/library/aa560610(BTS.20).aspx" href="http://msdn.microsoft.com/en-us/library/aa560610(BTS.20).aspx">http://msdn.microsoft.com/en-us/library/aa560610(BTS.20).aspx</a>    <p>You cannot access a SQL Server database by using the OLE DB provider for SQL Server when your application is in a high-stress scenario     <br /><a title="http://support.microsoft.com/kb/907264" href="http://support.microsoft.com/kb/907264">http://support.microsoft.com/kb/907264</a></p> </blockquote>  <blockquote>   <p>Description of TCP/IP settings that you may have to adjust when SQL Server connection pooling is disabled     <br /><a title="http://support.microsoft.com/kb/328476" href="http://support.microsoft.com/kb/328476">http://support.microsoft.com/kb/328476</a></p> </blockquote>  <blockquote>   <p>FIX: Error message when you connect to a named instance of SQL Server on a client computer that is running Windows Vista or Windows Server 2008: &quot;Specified SQL server not found&quot; or &quot;Error Locating Server/Instance Specified&quot;     <br /><a title="http://support.microsoft.com/kb/944390" href="http://support.microsoft.com/kb/944390">http://support.microsoft.com/kb/944390</a></p></blockquote>
