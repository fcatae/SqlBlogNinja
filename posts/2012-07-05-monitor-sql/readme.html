<a link='https://blogs.msdn.microsoft.com/fcatae/2012/07/05/monitor-sql/'>Monitor SQL</a>
<p>Antes que me esque&ccedil;a, quero publicar o script que usamos no dia a dia para analisar os servidores SQL. O objetivo &eacute; coletar o M&Aacute;XIMO de informa&ccedil;&atilde;o e de forma n&atilde;o-invasiva. Tenho usado com muito sucesso nesses &uacute;ltimos 2 anos e nunca tive problemas (exceto pelo tamanho do arquivo).</p>
<table style="background-color: #d3d3d3" border="0">
<tbody>
<tr>
<td>
<p><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe</span><br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">--</span><br /><span style="font-family: courier new,courier;font-size: xx-small">--</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPFE(@timespan INT = 12)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET LOCK_TIMEOUT 30000</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @startDate DATETIME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @prevDate DATETIME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @endDate DATETIME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @step INT = 0</span><br /><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT @startDate = GETDATE(), @prevDate = '1900-01-01', @step = 0</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @endDate = DATEADD(HOUR,@timespan,GETDATE())</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_SCRIPT_KATMAI Script v10.0.13 (SQL2008)'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT '&nbsp; SQL Instance:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + @@SERVERNAME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT '&nbsp; SQL Version:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR) + ' (' + CAST(SERVERPROPERTY('ProductLevel') AS VARCHAR) + ')'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT '&nbsp; Start time:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' + CONVERT(VARCHAR(24), GETDATE(), 121)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT '&nbsp; Scheduled end time: ' + CONVERT(VARCHAR(24), @endDate, 121)</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">-- SQL_TEXT --------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE TABLE #sqlquery_requested</span><br /><span style="font-family: courier new,courier;font-size: xx-small">(</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sql_handle&nbsp;&nbsp; varbinary(64),</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> stmt_start&nbsp;&nbsp; int,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> stmt_end&nbsp;&nbsp; int,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> query_hash&nbsp;&nbsp; binary(8),</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> query_plan_hash&nbsp; binary(8)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">CREATE TABLE #filehandle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">(</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> file_handle VARBINARY(8) PRIMARY KEY, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> database_id INT, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> file_id INT, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> filename NVARCHAR(260)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">EXEC #spBlockerPfe_0</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">WHILE @startDate &lt; @endDate</span><br /><span style="font-family: courier new,courier;font-size: xx-small">BEGIN</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT 'BLOCKER_PFE_BEGIN SqlMonData ' + CONVERT(VARCHAR(24), GETDATE(), 121)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small"> SET @startDate = GETDATE()</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> EXEC #spBlockerPfe_1 </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> EXEC #spBlockerPfe_1_handle</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> IF @step % 12 = 0 </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> BEGIN</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; DECLARE @savePrevDate DATETIME = GETDATE()</span><br />&nbsp; <br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; EXEC #spBlockerPfe_2 @prevDate</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; SET @prevDate = @savePrevDate</span><br />&nbsp; <br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; EXEC #spBlockerPfe_2_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> END</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small"> SET @step = @step + 1</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT 'BLOCKER_PFE_END SqlMonData ' + CONVERT(VARCHAR(24), GETDATE(), 121) + ' ' + convert(VARCHAR(12), datediff(ms,@startDate,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small"> RAISERROR('',0,1) WITH NOWAIT</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> WAITFOR DELAY '0:0:5'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">END</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">GO</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe_0') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe_0</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe_1') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe_1</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe_2') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe_2</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe_1_handle') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe_1_handle</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">IF OBJECT_ID('tempdb..#spBlockerPfe_2_handle') IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DROP PROCEDURE #spBlockerPfe_2_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPfe_0</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN MachineInfo'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'GeneralInformation'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT REPLICATE('-',100)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ServerName: ' + @@SERVERNAME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'PhysicalName: ' + CAST(SERVERPROPERTY('ComputerNamePhysicalNetBIOS') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ProductVersion: ' + CAST(SERVERPROPERTY('ProductVersion') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ProductLevel: ' + CAST(SERVERPROPERTY('ProductLevel') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ResourceVersion: ' + CAST(SERVERPROPERTY('ResourceVersion') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ResourceLastUpdateDateTime: ' + CAST(SERVERPROPERTY('ResourceLastUpdateDateTime') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'Edition: ' + CAST(SERVERPROPERTY('Edition') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'ProcessId: ' + CAST(SERVERPROPERTY('ProcessId') AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'SessionId: ' + CAST(@@SPID AS VARCHAR)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'Collation: ' + CAST(SERVERPROPERTY('Collation') AS VARCHAR(32))</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END MachineInfo ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN @@version'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT @@version AS 'version'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END @@version ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN xp_msver'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">EXEC xp_msver</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END xp_msver ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_sys_info'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sqlserver_start_time, -- 2008</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> cpu_count, hyperthread_ratio, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> physical_memory_in_bytes/1024/1024 AS 'physical_memory(MB)',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> bpool_committed*8/1024 AS 'buffer_pool(MB)', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> bpool_commit_target*8/1024 AS 'buffer_pool_target(MB)', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> bpool_visible*8/1024 AS 'buffer_visible(MB)', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> virtual_memory_in_bytes/1024/1024 AS 'virtual_memory(MB)',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> max_workers_count, scheduler_count</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_sys_info</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_sys_info '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_cluster_nodes'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT NodeName FROM sys.dm_os_cluster_nodes </span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_cluster_nodes '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_io_cluster_shared_drives'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT DriveName FROM sys.dm_io_cluster_shared_drives </span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_io_cluster_shared_drives '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.configurations'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT name, value=CAST(value AS VARCHAR(16)), value_in_use=CAST(value_in_use AS VARCHAR(16)) </span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.configurations</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY name</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.configurations ' + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.databases'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small">d.database_id, d.name, state_desc=CAST(d.state_desc AS VARCHAR(20)), user_access_desc=CAST(d.user_access_desc AS VARCHAR(16)), d.compatibility_level, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> d.create_date, collation_name=CAST(d.collation_name AS VARCHAR(64)), d.owner_sid, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> d.log_reuse_wait_desc, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> readonly = d.is_read_only, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> autoclose = d.is_auto_close_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> autoshrink = d.is_auto_shrink_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> standby = d.is_in_standby, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> cleanshut = d.is_cleanly_shutdown, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> supplog = d.is_supplemental_logging_enabled, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> snapshot = d.snapshot_isolation_state, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> readsnap = d.is_read_committed_snapshot_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> recovery = CAST(d.recovery_model_desc AS VARCHAR(8)), </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> pageverify =&nbsp; CAST(d.page_verify_option_desc AS VARCHAR(8)), </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> autostat_crt = d.is_auto_create_stats_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> autostat_upd = d.is_auto_update_stats_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> autostat_async = d.is_auto_update_stats_async_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> fulltext = d.is_fulltext_enabled, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> trustworthy = d.is_trustworthy_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> dbchain = d.is_db_chaining_on, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> paramforced = d.is_parameterization_forced, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> masterkey = d.is_master_key_encrypted_by_server, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> rep_pub = d.is_published, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> rep_sub = d.is_subscribed, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> rep_merge = d.is_merge_published, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> rep_dist = d.is_distributor, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sync_bkp = d.is_sync_with_backup, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sb_enabled = d.is_broker_enabled, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sb_guid = d.service_broker_guid, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> datacorr = d.is_date_correlation_on</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.databases d</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.databases '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.master_files'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- VIEW ANY DEFINITION</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> d.database_id, d.file_id, state_desc = CAST(d.state_desc AS VARCHAR(16)), type_desc=CAST(d.type_desc AS VARCHAR(16)), d.physical_name, d.file_guid, d.data_space_id, d.name, d.size, d.max_size, d.growth, d.is_media_read_only, d.is_read_only, d.is_sparse, d.is_percent_growth </span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.master_files d</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.master_files '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.master_files[Size]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- VIEW ANY DEFINITION</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> d.database_id, type_desc=CAST(d.type_desc AS VARCHAR(16)), </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(d.size AS BIGINT)*8/1024 AS 'Size(MB)', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CASE d.is_percent_growth </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; WHEN 0 THEN CAST(d.growth AS INT)*8/1024</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; WHEN 1 THEN CAST(d.growth AS INT)*CAST(d.size AS INT)/100*8/1024</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> END AS 'Growth(MB)',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CASE d.is_percent_growth </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; WHEN 0 THEN CAST( (100*d.growth/d.size) AS SMALLINT )</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; WHEN 1 THEN CAST( d.growth AS SMALLINT )</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> END AS 'Growth(perc)', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> d.physical_name</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.master_files d</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY d.physical_name</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.master_files[Size] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.traces'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- VIEW ANY DEFINITION</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> t.id, t.status, t.path, t.max_size, t.stop_time, t.max_files, t.is_rowset, t.is_rollover, t.is_shutdown, t.is_default, t.buffer_count, t.buffer_size, t.file_position, t.reader_spid, t.start_time, t.last_event_time, t.event_count, t.dropped_event_count </span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.traces t</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.traces '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">TRUNCATE TABLE #filehandle</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">INSERT #filehandle(file_handle, database_id, file_id, filename)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT vfs.file_handle, vfs.database_id, vfs.file_id, f.physical_name FROM sys.dm_io_virtual_file_stats(-1,-1) vfs</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> LEFT JOIN sys.master_files f ON vfs.database_id = f.database_id AND vfs.file_id = f.file_id</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_sessions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.session_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.login_time,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.status, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.cpu_time, s.memory_usage, s.total_scheduled_time, s.total_elapsed_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.last_request_start_time, s.last_request_end_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.reads, s.writes, s.logical_reads, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.row_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.prev_error</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_sessions s</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_sessions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_connections/sessions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.session_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.group_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.status AS VARCHAR(16)) AS 'status',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.host_name AS VARCHAR(20)) AS 'host_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.login_name AS VARCHAR(32)) AS 'login_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.program_name AS VARCHAR(64)) AS 'program_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.host_process_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.connection_id,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.original_login_name AS VARCHAR(32)) AS 'original_login_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.client_interface_name, s.client_version, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.auth_scheme AS VARCHAR(16)) AS 'auth_scheme', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.net_transport AS VARCHAR(16)) AS 'net_transport', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.client_net_address, c.client_tcp_port, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.most_recent_sql_handle AS VARBINARY(26)) AS 'most_recent_sql_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.net_packet_size, c.encrypt_option,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.connect_time, s.login_time</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_connections c left join sys.dm_exec_sessions s on c.session_id = s.session_id</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_connections/sessions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPfe_1</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET LOCK_TIMEOUT 250</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_requests'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.session_id, req.blocking_session_id AS 'blocked', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.database_id AS db_id, req.command, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.total_elapsed_time AS 'elapsed_time', req.cpu_time, req.granted_query_memory AS 'granted_memory', req.logical_reads, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.wait_time, CAST(req.wait_type AS VARCHAR(16)) AS 'wait_type', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.open_transaction_count AS 'tran_count', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.reads, req.writes,&nbsp; </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.start_time, req.status, req.connection_id, req.user_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.group_id, -- KATMAI (SQL2008)</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.transaction_id, req.request_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(req.plan_handle AS VARBINARY(26)) AS 'plan_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(req.sql_handle AS VARBINARY(26)) AS 'sql_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.nest_level,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.statement_start_offset AS 'stmt_start', req.statement_end_offset AS 'stmt_end', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.query_hash, req.query_plan_hash</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_requests req</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE group_id &gt; 1 -- KATMAI (SQL2008)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_requests '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_cursors'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.session_id, c.cursor_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DATEDIFF(ms, c.creation_time, GETDATE()) AS 'elapsed_time', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.worker_time, c.reads, c.writes, c.dormant_duration, c.fetch_buffer_start, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.ansi_position, c.is_open, c.fetch_status, c.creation_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.sql_handle AS VARBINARY(26)) AS 'sql_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.statement_start_offset AS 'stmt_start', c.statement_end_offset AS 'stmt_end', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.plan_generation_num, c.is_async_population, c.is_close_on_commit, c.fetch_buffer_size</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_cursors(0) c</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_cursors '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_query_memory_grants'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.session_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.query_cost, mg.dop, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> convert(VARCHAR(12), datediff(ms,request_time,getdate())) AS 'elapsed_time',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.wait_time_ms, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.resource_semaphore_id AS 'sem_id', mg.requested_memory_kb, mg.granted_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.used_memory_kb, mg.required_memory_kb, mg.max_used_memory_kb, mg.ideal_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.request_time, mg.grant_time, mg.timeout_sec, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.queue_id, mg.wait_order, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.request_id,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(mg.plan_handle AS VARBINARY(26)) AS 'plan_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(mg.sql_handle AS VARBINARY(26)) AS 'sql_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> mg.group_id, mg.pool_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_query_memory_grants mg</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_query_memory_grants '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_tasks'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.session_id, t.request_id, t.exec_context_id AS 'ecid',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">task_state = CAST(t.task_state AS NVARCHAR(10)), </span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.context_switches_count AS 'context_switches', t.pending_io_count AS 'pending_io',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.scheduler_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_tasks t</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE session_id IN (SELECT session_id FROM sys.dm_exec_sessions WHERE is_user_process=1)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_tasks '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_waiting_tasks'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">wt.session_id as 'spid', wt.blocking_session_id as 'blocked_spid', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wt.wait_duration_ms, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(wt.wait_type AS NVARCHAR(32)) AS 'wait_type', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(wt.resource_description AS NVARCHAR(128)) AS 'resource_description',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">wt.exec_context_id AS 'ecid', wt.blocking_exec_context_id AS 'block_ecid'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_waiting_tasks wt</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE session_id IN (SELECT session_id FROM sys.dm_exec_sessions WHERE is_user_process=1)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_waiting_tasks&nbsp; '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_database_transactions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.transaction_id, dt.database_id AS 'db_id', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">DATEDIFF(ms, dt.database_transaction_begin_time, GETDATE()) AS 'time_ms', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_type AS 'type', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_state AS 'state', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_log_record_count AS 'log_record_count', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_log_bytes_used AS 'log_bytes_used', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_log_bytes_reserved AS 'log_bytes_reserved', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_begin_time AS 'begin_time', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_begin_lsn AS 'begin_lsn', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_last_lsn AS 'last_lsn',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">dt.database_transaction_last_rollback_lsn AS 'rollback_lsn'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_database_transactions dt</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE database_transaction_begin_time is NOT NULL</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_database_transactions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">GO</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPfe_1_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET LOCK_TIMEOUT 250</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN CollectSqlHandle'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-- COLLECT ADHOC REQUEST</span><br /><span style="font-family: courier new,courier;font-size: xx-small">INSERT #sqlquery_requested</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sql_handle,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> statement_start_offset,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> statement_end_offset,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> query_hash,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> query_plan_hash</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_requests</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE sql_handle is not null AND session_id &lt;&gt; @@spid</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-- COLLECT CURSOR</span><br /><span style="font-family: courier new,courier;font-size: xx-small">INSERT #sqlquery_requested</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sql_handle,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> statement_start_offset,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> statement_end_offset,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_cursors(0)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-- OPENTRAN</span><br /><span style="font-family: courier new,courier;font-size: xx-small">INSERT #sqlquery_requested</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.most_recent_sql_handle,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 0,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 0,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_connections c</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE session_id IN (SELECT session_id FROM sys.dm_tran_session_transactions)&nbsp; AND session_id &lt;&gt; @@spid</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END CollectSqlHandle ' + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPfe_2(@prevDate DATETIME)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET LOCK_TIMEOUT 3000</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_resource_governor_resource_pools'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">select </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wp.pool_id, CAST(wp.name AS VARCHAR(16)) AS 'name', wp.statistics_start_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wp.total_cpu_usage_ms, wp.cache_memory_kb, wp.compile_memory_kb, wp.used_memgrant_kb, wp.total_memgrant_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wp.total_memgrant_timeout_count, wp.active_memgrant_count, wp.active_memgrant_kb, wp.memgrant_waiter_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wp.max_memory_kb, wp.used_memory_kb, wp.target_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wp.out_of_memory_count, wp.min_cpu_percent, wp.max_cpu_percent, wp.min_memory_percent, wp.max_memory_percent </span><br /><span style="font-family: courier new,courier;font-size: xx-small">from sys.dm_resource_governor_resource_pools wp</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_resource_governor_resource_pools '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_resource_governor_workload_groups'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.group_id, wg.pool_id, CAST(wg.name AS VARCHAR(16)) AS 'name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.active_request_count, wg.queued_request_count, wg.blocked_task_count, wg.active_parallel_thread_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.statistics_start_time, wg.total_request_count, wg.total_queued_request_count, wg.total_cpu_limit_violation_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_cpu_usage_ms, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_lock_wait_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_lock_wait_time_ms, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_query_optimization_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_suboptimal_plan_generation_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.total_reduced_memgrant_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.max_request_cpu_time_ms, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.max_request_grant_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.request_max_memory_grant_percent,</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(wg.importance AS VARCHAR(16)) AS 'importance', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.request_max_cpu_time_sec, wg.group_max_requests, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">wg.request_memory_grant_timeout_sec, wg.max_dop</span><br /><span style="font-family: courier new,courier;font-size: xx-small">from sys.dm_resource_governor_workload_groups wg</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_resource_governor_workload_groups '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_schedulers'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sos.scheduler_id, sos.is_online, sos.is_idle, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sos.current_tasks_count, sos.runnable_tasks_count, sos.active_workers_count, sos.current_workers_count, sos.work_queue_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> sos.pending_disk_io_count, sos.scheduler_address</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_schedulers sos</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_schedulers '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_waiting_tasks[BlockedSessions]';</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">;WITH cteBlockedSessions</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> (</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> SELECT session_id, blocking_session_id FROM sys.dm_os_waiting_tasks </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> WHERE blocking_session_id &lt;&gt; session_id </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> )</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> blk.blocking_session_id AS 'session_id', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.most_recent_sql_handle AS VARBINARY(26)) as 'most_recent_sql_handle',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> at.transaction_id,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DATEDIFF(ms, at.transaction_begin_time, GETDATE()) AS 'elapsed_time',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(r.sql_handle AS VARBINARY(26)) as 'sql_handle',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> r.statement_start_offset, r.statement_end_offset,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> at.transaction_begin_time, at.transaction_state </span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM cteBlockedSessions blk </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> INNER JOIN sys.dm_exec_connections c ON blk.blocking_session_id = c.session_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> INNER JOIN sys.dm_tran_session_transactions st ON st.session_id = c.session_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> INNER JOIN sys.dm_tran_active_transactions at ON st.transaction_id = at.transaction_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> LEFT JOIN sys.dm_exec_requests r ON c.session_id = r.session_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE blk.blocking_session_id not in (SELECT session_id FROM cteBlockedSessions)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_waiting_tasks[BlockedSessions] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_sys_memory'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- SQL 2008</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small">s.system_high_memory_signal_state, s.system_low_memory_signal_state, s.available_physical_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">s.available_page_file_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">s.system_cache_kb, s.kernel_paged_pool_kb, s.kernel_nonpaged_pool_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">s.total_physical_memory_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">s.total_page_file_kb</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_sys_memory s</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_sys_memory '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_process_memory'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- SQL 2008</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">p.process_physical_memory_low, p.process_virtual_memory_low,</span><br /><span style="font-family: courier new,courier;font-size: xx-small">p.memory_utilization_percentage AS 'memory_utilization', p.available_commit_limit_kb, p.virtual_address_space_available_kb,</span><br /><span style="font-family: courier new,courier;font-size: xx-small">p.physical_memory_in_use_kb, p.large_page_allocations_kb, p.locked_page_allocations_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">p.virtual_address_space_reserved_kb, p.virtual_address_space_committed_kb, p.total_virtual_address_space_kb</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_process_memory p</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END dm_os_process_memory '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_memory_clerks'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">mc.type, total_kb = mc.single_pages_kb+mc.multi_pages_kb+mc.virtual_memory_committed_kb,</span><br /><span style="font-family: courier new,courier;font-size: xx-small">mc.memory_node_id, mc.single_pages_kb, mc.multi_pages_kb, mc.virtual_memory_reserved_kb, mc.virtual_memory_committed_kb, mc.awe_allocated_kb, mc.shared_memory_reserved_kb, mc.shared_memory_committed_kb, mc.name</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_memory_clerks mc</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE single_pages_kb+multi_pages_kb+virtual_memory_committed_kb &gt; 102400</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_memory_clerks '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_memory_brokers'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">mb.pool_id, mb.memory_broker_type, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">mb.allocations_kb, mb.allocations_kb_per_sec, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">mb.predicted_allocations_kb, mb.target_allocations_kb, mb.future_allocations_kb, mb.overall_limit_kb, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">last_notification = CAST(mb.last_notification AS VARCHAR(8))</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_memory_brokers mb</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_memory_brokers '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br />&nbsp; <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_active_transactions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.transaction_id, t.name, t.transaction_begin_time, t.transaction_type, t.transaction_state</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_active_transactions t</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE transaction_type &lt;&gt; 2 -- read-only transaction</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_active_transactions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_session_transactions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">session_id, transaction_id, is_user_transaction AS 'is_user', is_local</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_session_transactions</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_session_transactions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_active_snapshot_database_transactions'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> a.session_id, a.elapsed_time_seconds, a.is_snapshot, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> a.transaction_id, a.transaction_sequence_num, a.first_snapshot_sequence_num, a.max_version_chain_traversed, a.average_version_chain_traversed</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_active_snapshot_database_transactions a</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_active_snapshot_database_transactions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_requests[System]'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.session_id, req.blocking_session_id AS 'blocked', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.database_id AS db_id, req.command, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.total_elapsed_time AS 'elapsed_time', req.cpu_time, req.granted_query_memory AS 'granted_memory', req.logical_reads, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.wait_time, CAST(req.wait_type AS VARCHAR(16)) AS 'wait_type', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.open_transaction_count AS 'tran_count', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.reads, req.writes,&nbsp; </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.start_time, req.status, req.connection_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.transaction_id, req.task_address, req.request_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_requests req</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE group_id = 1</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_requests[System] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN dm_os_tasks[System]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.task_address, t.session_id, t.request_id, t.exec_context_id AS 'ecid',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">task_state = CAST(t.task_state AS NVARCHAR(10)), </span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.context_switches_count AS 'context_switches', t.pending_io_count AS 'pending_io',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">t.scheduler_id, t.worker_address</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_os_tasks t</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE worker_address IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> AND (session_id IN (SELECT session_id FROM sys.dm_exec_sessions WHERE is_user_process=0) OR session_id IS NULL)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_tasks[System] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_sessions[last_request_time]'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @lasttime DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @lasttime = @prevDate</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-- SET @lasttime = DATEADD(s,-60,GETDATE())</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.session_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.login_time,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.status, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.cpu_time, s.memory_usage, s.total_scheduled_time, s.total_elapsed_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.last_request_start_time, s.last_request_end_time, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.reads, s.writes, s.logical_reads, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.row_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.prev_error</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_sessions s </span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE (s.last_request_end_time &gt; @lasttime OR s.last_request_end_time IS NULL) OR s.last_request_start_time &gt; @lasttime</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_sessions[last_request_time] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_connections/sessions'</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">-- DECLARE @lasttime DATETIME</span><br /><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @tbSessions TABLE (spid INT PRIMARY KEY)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">INSERT @tbSessions(spid)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT DISTINCT session_id FROM</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> (</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; SELECT session_id FROM sys.dm_exec_requests</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> UNION ALL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; SELECT session_id FROM sys.dm_tran_session_transactions</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> UNION ALL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; SELECT blocking_session_id FROM sys.dm_os_waiting_tasks WHERE blocking_session_id IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> UNION ALL </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; SELECT session_id FROM sys.dm_exec_connections c</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; WHERE c.connect_time &gt; @lasttime</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> ) t</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> WHERE session_id IS NOT NULL</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.session_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.group_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.status AS VARCHAR(16)) AS 'status',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.host_name AS VARCHAR(20)) AS 'host_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.login_name AS VARCHAR(32)) AS 'login_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.program_name AS VARCHAR(64)) AS 'program_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.host_process_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.connection_id,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.original_login_name AS VARCHAR(32)) AS 'original_login_name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.client_interface_name, s.client_version, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.auth_scheme AS VARCHAR(16)) AS 'auth_scheme', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.net_transport AS VARCHAR(16)) AS 'net_transport', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.client_net_address, c.client_tcp_port, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(c.most_recent_sql_handle AS VARBINARY(26)) AS 'most_recent_sql_handle', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.net_packet_size, c.encrypt_option,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.connect_time, s.login_time</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_connections c left join sys.dm_exec_sessions s on c.session_id = s.session_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE c.session_id IN (SELECT spid FROM @tbSessions)</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_connections/sessions '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_wait_stats'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">select </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> w.wait_type, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> w.waiting_tasks_count, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> w.wait_time_ms, w.max_wait_time_ms, w.signal_wait_time_ms</span><br /><span style="font-family: courier new,courier;font-size: xx-small">from sys.dm_os_wait_stats w where wait_time_ms &gt; 60000</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_wait_stats '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_latch_stats'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">select</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> l.latch_class, l.waiting_requests_count, l.wait_time_ms, l.max_wait_time_ms</span><br /><span style="font-family: courier new,courier;font-size: xx-small">from sys.dm_os_latch_stats l where wait_time_ms &gt; 60000</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_latch_stats '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_os_spinlock_stats'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">select </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(s.name AS VARCHAR(64)) AS 'name', </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> s.collisions, s.spins, s.spins_per_collision, s.sleep_time, s.backoffs</span><br /><span style="font-family: courier new,courier;font-size: xx-small">from sys.dm_os_spinlock_stats s where sleep_time &gt; 100</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_os_spinlock_stats '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_exec_query_resource_semaphores'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> qrsem.resource_semaphore_id, qrsem.target_memory_kb, qrsem.max_target_memory_kb, qrsem.total_memory_kb, qrsem.available_memory_kb, qrsem.granted_memory_kb, qrsem.used_memory_kb, qrsem.grantee_count, qrsem.waiter_count, qrsem.timeout_error_count, qrsem.forced_grant_count, qrsem.pool_id</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_query_resource_semaphores qrsem</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_exec_query_resource_semaphores '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_io_pending_io_requests'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @pending_io_requests_summary INT = 0</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT TOP 512</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> io.io_pending_ms_ticks, io.io_pending, io.scheduler_address, io_pending_handle=io.io_handle, io.io_offset</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_io_pending_io_requests io</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY io_pending_ms_ticks DESC</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">--IF @@ROWCOUNT &gt; 32</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET @pending_io_requests_summary = 1</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_io_pending_io_requests '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">IF @pending_io_requests_summary = 1 </span><br /><span style="font-family: courier new,courier;font-size: xx-small">BEGIN</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT 'BLOCKER_PFE_BEGIN sys.dm_io_pending_io_requests[summary]'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small"> SELECT * FROM </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; (SELECT count=COUNT(*), avg_pending_ms_ticks=AVG(io_pending_ms_ticks), io_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; FROM sys.dm_io_pending_io_requests WHERE io_pending = 1 GROUP BY io_handle) i</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> LEFT JOIN #filehandle f ON i.io_handle = f.file_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> ORDER BY avg_pending_ms_ticks DESC</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small"> PRINT 'BLOCKER_PFE_END sys.dm_io_pending_io_requests[summary] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /><span style="font-family: courier new,courier;font-size: xx-small">END</span><br />&nbsp; <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_io_virtual_file_stats'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> fs.database_id, fs.file_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> fs.num_of_reads, fs.num_of_bytes_read, fs.io_stall_read_ms, fs.num_of_writes, fs.num_of_bytes_written, fs.io_stall_write_ms, fs.io_stall, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> fs.size_on_disk_bytes, virtual_file_handle = fs.file_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_io_virtual_file_stats (-1,-1) fs</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_io_virtual_file_stats '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.databases[log_reuse_wait_desc]'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT d.name, d.log_reuse_wait_desc</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.databases d </span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE d.log_reuse_wait &lt;&gt; 0</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.databases[log_reuse_wait_desc] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN DBCC_SQLPERF_LOGSPACE'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DBCC SQLPERF(LOGSPACE)</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END DBCC_SQLPERF_LOGSPACE '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN DBCC_OPENTRAN'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @dbid INT</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE curDatabases CURSOR FAST_FORWARD FOR</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT database_id FROM sys.databases</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">OPEN curDatabases;</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">FETCH NEXT FROM curDatabases INTO @dbid;</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">WHILE (@@FETCH_STATUS &lt;&gt; -1)</span><br /><span style="font-family: courier new,courier;font-size: xx-small">BEGIN</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> DBCC OPENTRAN(@dbid)</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> FETCH NEXT FROM curDatabases INTO @dbid</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">END</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DEALLOCATE curDatabases</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END DBCC_OPENTRAN '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_locks[OBJECTS]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">l.resource_database_id AS 'db_id', l.resource_associated_entity_id AS 'entity_id', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(l.request_mode AS VARCHAR(8)) AS req_mode, req_status = CAST(l.request_status AS VARCHAR(8)),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">l.request_session_id AS 'session_id', l.request_owner_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">resource_subtype = CAST(l.resource_subtype AS VARCHAR(16)),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">object_description = CASE WHEN request_mode NOT LIKE 'Sch-%' THEN </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; DB_NAME(resource_database_id) + N'.' +</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_SCHEMA_NAME(resource_associated_entity_id, resource_database_id) + N'.' +</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_NAME(resource_associated_entity_id, resource_database_id) AS NVARCHAR(64))</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> ELSE CAST(resource_description AS NVARCHAR(64)) END </span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_locks l</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE l.resource_type = 'OBJECT'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_locks[OBJECTS] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN sys.dm_tran_locks[WAIT]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(l.resource_type AS VARCHAR(12)) AS 'resource_type',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">l.resource_database_id AS 'db_id', l.resource_associated_entity_id AS 'entity_id', </span><br /><span style="font-family: courier new,courier;font-size: xx-small">CAST(l.request_mode AS VARCHAR(8)) AS 'req_mode', req_status = CAST(l.request_status AS VARCHAR(8)),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">l.request_session_id AS 'session_id', l.request_owner_id, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">resource_subtype = CAST(l.resource_subtype AS VARCHAR(16)),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">resource_description =</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CASE WHEN l.resource_type = 'OBJECT' AND request_mode NOT LIKE 'Sch-%' THEN </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; CAST(</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; DB_NAME(resource_database_id) + N'.' +</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_SCHEMA_NAME(resource_associated_entity_id, resource_database_id) + N'.' +</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_NAME(resource_associated_entity_id, resource_database_id) AS NVARCHAR(64))</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> ELSE CAST(resource_description AS NVARCHAR(64)) END</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_tran_locks l</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE l.request_status = 'WAIT'</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END sys.dm_tran_locks[WAIT] '&nbsp; + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">GO</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CREATE PROCEDURE #spBlockerPfe_2_handle</span><br /><span style="font-family: courier new,courier;font-size: xx-small">AS</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET NOCOUNT ON</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SET LOCK_TIMEOUT 3000</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">DECLARE @time DATETIME</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN CollectSqlHandle2'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-- OPENTRAN</span><br /><span style="font-family: courier new,courier;font-size: xx-small">INSERT #sqlquery_requested</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> c.most_recent_sql_handle,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 0,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 0,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM sys.dm_exec_connections c</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE session_id IN (SELECT session_id FROM sys.dm_tran_session_transactions) AND session_id &lt;&gt; @@spid</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END CollectSqlHandle2 ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN FlushSqlHandle[object_name]'</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SELECT DISTINCT</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(req.sql_handle AS VARBINARY(26)) AS 'sql_handle',</span><br /> <br /><span style="font-family: courier new,courier;font-size: xx-small"> CAST(</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; DB_NAME(dbid) + N'.' + </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_SCHEMA_NAME(objectid,dbid) + N'.' + </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp; OBJECT_NAME(objectid,dbid) AS NVARCHAR(128)) AS 'object_name',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> st.dbid, st.objectid</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM #sqlquery_requested req</span><br /><span style="font-family: courier new,courier;font-size: xx-small">CROSS APPLY sys.dm_exec_sql_text(req.sql_handle) st</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE objectid IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY dbid, objectid</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END FlushSqlHandle[object_name] ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN FlushSqlHandle[sqlquery_requested]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT</span><br /><span style="font-family: courier new,courier;font-size: xx-small">'COUNT=',&nbsp;&nbsp; Count=COUNT(*),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">'SQLHANDLE=',&nbsp; CAST(req.sql_handle AS VARBINARY(26)) AS 'sql_handle',</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.stmt_start, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.stmt_end,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 'QUERY_HASH=',&nbsp; req.query_hash,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 'QUERY_PLAN_HASH=', req.query_plan_hash</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM #sqlquery_requested req</span><br /><span style="font-family: courier new,courier;font-size: xx-small">WHERE req.query_hash IS NOT NULL</span><br /><span style="font-family: courier new,courier;font-size: xx-small">GROUP BY sql_handle, query_hash, stmt_start, req.stmt_end, req.query_plan_hash</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY COUNT(*) DESC</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END FlushSqlHandle[sqlquery_requested] ' + convert(VARCHAR(12), datediff(ms,@time,getdate()))</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">SET @time = GETDATE()</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT ''</span><br /><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_BEGIN FlushSqlHandle[dm_exec_sql_text]'</span><br /><span style="font-family: courier new,courier;font-size: xx-small">SELECT TOP 1000</span><br /><span style="font-family: courier new,courier;font-size: xx-small">'COUNT=',&nbsp;&nbsp; COUNT(*),</span><br /><span style="font-family: courier new,courier;font-size: xx-small">'SQLHANDLE=',&nbsp; CAST(req.sql_handle AS VARBINARY(26)) AS 'sql_handle',</span><br /><span style="font-family: courier new,courier;font-size: xx-small">'SQLHASH=',&nbsp;&nbsp; req.query_hash,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.stmt_start, </span><br /><span style="font-family: courier new,courier;font-size: xx-small"> req.stmt_end,</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> CHAR(13) + CHAR(10),</span><br /><span style="font-family: courier new,courier;font-size: xx-small"> 'SQLTEXT=',&nbsp;&nbsp; sqltext=(SELECT SUBSTRING( text, stmt_start/2 + 1, </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((CASE WHEN stmt_end = -1 THEN DATALENGTH(text) </span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WHEN stmt_end = 0 THEN 1024</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ELSE stmt_end END) - stmt_start)/2 )</span><br /><span style="font-family: courier new,courier;font-size: xx-small">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FROM sys.dm_exec_sql_text(sql_handle))</span><br /><span style="font-family: courier new,courier;font-size: xx-small">FROM #sqlquery_requested req </span><br /><span style="font-family: courier new,courier;font-size: xx-small">GROUP BY sql_handle, query_hash, stmt_start, req.stmt_end</span><br /><span style="font-family: courier new,courier;font-size: xx-small">ORDER BY COUNT(*) DESC</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">TRUNCATE TABLE #sqlquery_requested</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">PRINT 'BLOCKER_PFE_END FlushSqlHandle[dm_exec_sql_text] ' + convert(VARCHAR(12), datediff(ms,@time,getdate())) </span><br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">GO</span></p>
<p><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span><br /><span style="font-family: courier new,courier;font-size: xx-small">EXEC #spBlockerPFE</span><br /><span style="font-family: courier new,courier;font-size: xx-small">-----------------------------------------------------------------------------------------------------</span></p>
</td>
</tr>
</tbody>
</table>
<p><span style="font-family: courier new,courier"></span></p>
