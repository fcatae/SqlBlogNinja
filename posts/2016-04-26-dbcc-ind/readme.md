<a link='https://blogs.msdn.microsoft.com/fcatae/2016/04/26/dbcc-ind/'>DBCC IND</a>
<p>Esse &eacute; mais um artigo da s&eacute;rie &ldquo;Saga da otimiza&ccedil;&atilde;o com comandos antigos&rdquo;<ul>   <li>Parte 1: <a href="http://blogs.msdn.com/b/fcatae/archive/2016/03/22/set-statistics-io.aspx">SET STATISTICS IO</a></li>    <li>Parte 2: <a href="http://blogs.msdn.com/b/fcatae/archive/2016/03/29/dbcc-dropcleanbuffers.aspx">DBCC DROPCLEANBUFFERS</a></li>    <li>Parte 3: <a href="http://blogs.msdn.com/b/fcatae/archive/2016/04/05/dbcc-showcontig.aspx">DBCC SHOWCONTIG</a></li>    <li>Parte 4: <a href="http://blogs.msdn.com/b/fcatae/archive/2016/04/12/dbcc-page.aspx">DBCC PAGE</a></li>    <li>Parte 5: <a href="http://blogs.msdn.com/b/fcatae/archive/2016/04/19/sp-spaceused.aspx">sp_spaceused</a></li> </ul><p>No &uacute;ltimo artigo, apresentei um problema muito comum nas estruturas HEAPS para armazenamento de dados. Agora vamos falar da equival&ecirc;ncia:</p><blockquote>   <p>Table scan = Heap scan = Allocation ordered scan = IAM scan</p> </blockquote><p>Voc&ecirc; sabe o que isso significa? Vamos come&ccedil;ar explicando o conceito central, que &eacute; a Heap.</p><h3>Heap</h3><p>Heap &eacute; uma estrutura de dados composta apenas por um conjunto de p&aacute;gina de dados. Encontramos v&aacute;rias refer&ecirc;ncias nas quais Heap &eacute; sin&ocirc;nimo de Tabela, por isso, &eacute; comum dizer que:</p><blockquote>   <p>Table scan = Heap scan</p> </blockquote><p>Isso faz sentido, pois muitas vezes a Tabela corresponde aos dados na forma l&oacute;gica:</p><blockquote>   <p><a href="images\1512.image_60349C25.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\8004.image_thumb_489CEEB2.png" width="313" height="316"></a></p> </blockquote><p>Enquanto que a Heap representa o conjunto de p&aacute;ginas que armazenam os dados, ou seja, seria a forma f&iacute;sica:</p><blockquote>   <p><a href="images\3482.image_0F1C6F6C.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\3652.image_thumb_795517BF.png" width="446" height="378"></a></p>    <p>&nbsp;</p> </blockquote><h3>Index Allocation Map (IAM)</h3><p>Al&eacute;m das p&aacute;ginas de dados, existe uma p&aacute;gina (ou mais p&aacute;ginas quando a tabela &eacute; grande) denominada de Index Allocation Map (IAM). </p><p>Tamb&eacute;m &eacute; comum ouvir que:</p><blockquote>   <p>Heap scan = Allocation ordered scan = IAM scan</p> </blockquote><p>O conceito &eacute; simples! Fica mais f&aacute;cil de entender com a ajuda do comando DBCC IND.</p><blockquote>   <p>DBCC IND(dbid, table, 0)</p> </blockquote><blockquote>   <p><a href="images\6138.image_4DA6DE74.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;margin: 0px;padding-right: 0px" border="0" alt="image" src="images\8625.image_thumb_13B79B88.png" width="239" height="244"></a></p> </blockquote><blockquote>   <p>FID = File_ID     <br>PID = Page_ID</p> </blockquote><p>Aqui observamos a tabela &eacute; composta pelas p&aacute;ginas: 329, 537-543, 360-363, sendo que todas pertencem ao arquivo (FID) 1. Tamb&eacute;m observamos que o IAM corresponde &agrave; p&aacute;gina 1:329 (FILE_ID=1, PAGE_ID=329) e ele cont&eacute;m o ponteiro para todas as p&aacute;ginas. Ela seria o mapeamento de todas as p&aacute;ginas que pertencem a um determinado objeto.</p><blockquote>   <p><a href="images\3240.image_08246EFA.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="images\1526.image_thumb_5E43FAC4.png" width="191" height="175"></a></p> </blockquote><p>Podemos dizer que uma estrutura de aloca&ccedil;&atilde;o &eacute; composta por uma ou mais p&aacute;ginas IAM. Isso ocorre porque o IAM possui apenas 8Kb de tamanho e nem sempre consegue armazenar todos os ponteiros necess&aacute;rios. Portanto, um Allocation Unit &eacute; igual a um conjunto de IAM.</p><h3>IAM Scan</h3><p>Como disse no come&ccedil;o do artigo, temos a equival&ecirc;ncia:</p><blockquote>   <p>Table scan = Heap scan = Allocation ordered scan = IAM scan</p> </blockquote><p>Que poderia ser quebrada em partes:</p><blockquote>   <p>Table e Heap</p> </blockquote><p>Tabela &eacute; uma entidade l&oacute;gica composta pelos DADOS e METADADOS. No desenho anterior, a primeira linha da tabela corresponde ao cabe&ccedil;alho, que corresponde ao nome das colunas. Esse &eacute; o metadado, que descreve as colunas e os tipos de dado. Os dados brutos s&atilde;o armazenados em uma estrutura de dados, que no caso &eacute; a Heap. Nem sempre os dados ficam em uma Heap. Poderia ser uma estrutura do tipo BTree+ ou os dados ficam distribu&iacute;dos entre v&aacute;rias estruturas Heaps/BTrees (ex: Particionamento).</p><blockquote>   <p>Heap e Allocation Unit</p> </blockquote><p>Allocation Unit &eacute; um espa&ccedil;o de aloca&ccedil;&atilde;o no disco. Heap pode utilizar 3 Allocation Units ao mesmo tempo: In-Row, Row Overflow, LOB. Quando falamos em um Heap scan, estamos falando de uma opera&ccedil;&atilde;o de Scan em um Allocation Unit corresponde ao In-Row.</p><blockquote>   <p>Allocation Unit e IAM</p> </blockquote><p>Allocation Unit corresponde ao conjunto de IAM. IAM &eacute; uma p&aacute;gina de 8Kb com ponteiros para Extents, estando diretamente relacionado com os arquivos em disco. IAM possui ponteiros entre outros IAM (lista duplamente ligada). Por outro lado, Allocation Unit corresponde a uma estrutura que ajuda o banco de dados a alocar espa&ccedil;o em disco sem se preocupar com os detalhes dos arquivos.</p><p>No fim conclu&iacute;mos que: Table, Heap, Allocation Unit e IAM s&atilde;o conceitos bem diferentes.</p><p>Ent&atilde;o por que dizer que existe uma equival&ecirc;ncia entre as opera&ccedil;&otilde;es de scan? N&atilde;o sei exatamente o motivo, mas muita gente usa essas express&otilde;es livremente. O importante &eacute; deixar claro que o IAM scan &eacute; a opera&ccedil;&atilde;o mais r&aacute;pida de Table Scan presente no SQL Server. IAM scan aumenta a chance de realizar opera&ccedil;&otilde;es de read-ahead usando um mecanismo chamado de &ldquo;read-scatter&rdquo;, que procura agregar as opera&ccedil;&otilde;es de leituras sequenciais pr&oacute;ximas.</p><p>No pr&oacute;ximo artigo, vamos ver a estrutura de BTree e introduzir um conceito chamado de Index Scan. Ser&aacute; que esse mecanismo &eacute; mais r&aacute;pido que o Heap scan?</p></p>

