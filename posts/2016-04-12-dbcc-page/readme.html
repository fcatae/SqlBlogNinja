<a link='https://blogs.msdn.microsoft.com/fcatae/2016/04/12/dbcc-page/'>DBCC PAGE</a>
<p>Continuando a s&eacute;rie dos comandos hist&oacute;ricos, vamos falar sobre o famoso <strong>DBCC PAGE</strong>. Esse &eacute; o quarto artigo da s&eacute;rie: j&aacute; comentei sobre o <a href="http://blogs.msdn.com/b/fcatae/archive/2016/03/22/set-statistics-io.aspx">SET STATISTICS IO</a>, <a href="http://blogs.msdn.com/b/fcatae/archive/2016/03/29/dbcc-dropcleanbuffers.aspx">DBCC DROPCLEANBUFFERS</a> e <a href="http://blogs.msdn.com/b/fcatae/archive/2016/04/05/dbcc-showcontig.aspx">DBCC SHOWCONTIG</a>.<p>Vou recriar o ambiente do LOJADB:</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1373.image_114FBE9F.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8345.image_thumb_705EDCA8.png" width="385" height="238"></a></p> </blockquote><p>Em seguida, quero me certificar que est&aacute; funcionando tudo corretamente.</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5127.image_521425B2.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8510.image_thumb_22590DE4.png" width="388" height="215"></a></p> </blockquote><p>Antes de continuar, algumas pessoas desconfiaram da forma como construi a tabela. Estou usando o tipo de dados CHAR(800) ao inv&eacute;s do tradicional VARCHAR. Por isso, vou mudar o tipo de coluna. Por ser um tipo vari&aacute;vel, vou trocar para VARCHAR(1000).</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/8304.image_3D9166E5.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7120.image_thumb_6B1286A8.png" width="263" height="67"></a></p> </blockquote><p>A tabela foi alterada para a nova coluna VARCHAR.</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2260.image_51AA836E.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2364.image_thumb_0CFDE92D.png" width="702" height="160"></a></p> </blockquote><p>Rodei o sp_spaceused antes de come&ccedil;ar os testes para validar a quantidade de registro e o tamanho da tabela. Curiosamente, n&atilde;o lembro da tabela ocupar 20MB, parece que est&aacute; maior.</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6242.image_01682BEE.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2548.image_thumb_75D26EAE.png" width="382" height="136"></a></p> </blockquote><p>Vamos fazer o teste de desempenho. Come&ccedil;arei limpando o cache e depois habilitando o SET STATISTICS TIME e SET STATISTICS IO.</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/3124.image_3C4F5EB7.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6114.image_thumb_6559FDB3.png" width="715" height="315"></a></p> </blockquote><p>Apenas para manter a consist&ecirc;ncia dos testes, vou desabilitar o read-head usando o Trace Flag global 652. Limpando o cache e executando novamente:</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/7608.image_52A503FC.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2768.image_thumb_69D30F2B.png" width="701" height="287"></a></p> </blockquote><p>Consegui bater o recorde do tempo! Agora a query est&aacute; rodando em 2659ms.</p><p>&nbsp;</p><h3>Investiga&ccedil;&atilde;o usando o DBCC PAGE</h3><p>Por algum motivo houve um aumento significativo no n&uacute;mero de logical reads (7502), assim como nas leituras f&iacute;sicas (2506). Por isso, comecei olhando as p&aacute;ginas em mem&oacute;ria do Buffer Pool. Encontrei exatamente 2509 p&aacute;ginas pertencentes ao LOJADB. No entanto, o que me chamou a aten&ccedil;&atilde;o foi existir p&aacute;ginas com 8 registros e outras, com apenas 4.</p><p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6825.image_2930C2BC.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/4380.image_thumb_72566E75.png" width="724" height="222"></a></p><p>A investiga&ccedil;&atilde;o continua com a ajuda do <strong>DBCC PAGE</strong>.</p><p>Esse comando est&aacute; dispon&iacute;vel desde os prim&oacute;rdios do SQL Server e deve ser usado em conjunto com o Trace Flag 3604.</p><blockquote>   <p>DBCC PAGE (SQL 6.5)     <br><a title="https://support.microsoft.com/en-us/kb/83065" href="https://support.microsoft.com/en-us/kb/83065">https://support.microsoft.com/en-us/kb/83065</a></p> </blockquote><p>A sintaxe &eacute; simples: </p><blockquote>   <p>DBCC PAGE(dbid, file_id, page_id, opt)</p> </blockquote><p>Vamos investigar a p&aacute;gina 26057, que possui 4 registros.</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/1321.image_4F9536B8.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6215.image_thumb_362D337E.png" width="195" height="53"></a></p> </blockquote><blockquote>   <p>Cabe&ccedil;alho:</p>    <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0268.image_1F6DEBF5.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/5415.image_thumb_018F67F4.png" width="480" height="342"></a></p>    <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/6663.image_50FBEA3B.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/2570.image_thumb_59EB7C7A.png" width="480" height="506"></a></p> </blockquote><p>A resposta est&aacute; no tipo de registro armazenado! Esses 4 registros s&atilde;o FORWARDED_RECORD. </p><p>Rodando o DBCC PAGE nas p&aacute;ginas com 8 registros, encontro os ponteiros FORWARDING_STUB:</p><blockquote>   <p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/4034.image_5915A741.png"><img title="image" style="border-top: 0px;border-right: 0px;border-bottom: 0px;padding-top: 0px;padding-left: 0px;border-left: 0px;padding-right: 0px" border="0" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/28/29/metablogapi/0654.image_thumb_3B372340.png" width="485" height="94"></a></p> </blockquote><p>O mist&eacute;rio est&aacute; resolvido. Ao executar o comando ALTER TABLE - ALTER COLUMN, os registros foram &ldquo;expulsos&rdquo; da p&aacute;gina para uma p&aacute;gina externa usando os mecanismos de &ldquo;forwarded records&rdquo;. </p><p>Existe uma boa explica&ccedil;&atilde;o disso no livro &ldquo;Inside SQL Server&rdquo;. Tamb&eacute;m encontrei esse artigo do Paul Randal:</p><blockquote>   <p><a href="http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-record/">Inside the Storage Engine: Anatomy of a record</a>      <br><a title="http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-record/" href="http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-record/">http://www.sqlskills.com/blogs/paul/inside-the-storage-engine-anatomy-of-a-record/</a></p> </blockquote><p>&nbsp;</p><h3>Conclus&atilde;o</h3><p>Ao mudar o tipo de dado da coluna, for&ccedil;amos a ocorr&ecirc;ncia de Forwarded Records e causamos a fragmenta&ccedil;&atilde;o de dados em disco. Esse problema ocorreu porque a tabela est&aacute; organizado como Heap e n&atilde;o estamos trabalhando com Clustered Index. </p><p>No pr&oacute;ximo artigo, vou mostrar um comportamento muito curioso das Heaps. Ainda preciso pensar no t&iacute;tulo.</p></p>

