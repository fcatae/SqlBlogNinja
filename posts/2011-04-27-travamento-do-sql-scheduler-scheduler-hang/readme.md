<a link='https://blogs.msdn.microsoft.com/fcatae/2011/04/27/travamento-do-sql-scheduler-scheduler-hang/'>Travamento do SQL Scheduler (Scheduler Hang)</a>
<blockquote>   <p>Introdução: <a href="http://blogs.msdn.com/b/fcatae/archive/2011/03/09/sql-scheduler-cooperative-mode.aspx" target="_blank">SQL Scheduler (Cooperative Mode)</a></p>    <p>SQL Thread Yield: <a href="http://blogs.msdn.com/b/fcatae/archive/2011/03/28/sos-scheduler-yield.aspx" target="_blank">SQL Scheduler Yield</a></p> </blockquote>  <p>Apesar do SQL Scheduler ser o componente responsável pelo gerenciamento de threads do SQL Server, as threads são as principais responsáveis pelo funcionamento balanceado no modo cooperativo. Cada thread determina o tempo necessário para rodar parte da sua tarefa e, em seguida, passa o controle para a próxima thread disponível. </p>  <blockquote>   <p><a href="images\6102.image_472ACFD3.png"><img title="image" border="0" alt="image" src="images\5037.image_thumb_4C2D0D82.png" width="214" height="240" /></a></p> </blockquote>  <p>Essa arquitetura interna do SQL Server garante desempenho e escalabilidade. Por outro lado, existem situações problemáticas nas quais uma thread não realiza a operação de YIELD corretamente. Nesse caso, cria-se a situação de monopólio do Scheduler e somente uma única thread fica rodando – as demais threads ficam esperando para executar.</p>  <p>&#160;</p>  <blockquote>   <p><a href="images\2313.image_4B8E2F8D.png"><img style="border-right-width: 0px;margin: 0px;padding-left: 0px;padding-right: 0px;border-top-width: 0px;border-bottom-width: 0px;border-left-width: 0px;padding-top: 0px" title="image" border="0" alt="image" src="images\0245.image_thumb_4566E2F2.png" width="218" height="240" /></a></p> </blockquote>  <p>Essa é a situação chamada de Travamento do Scheduler (em inglês, Scheduler Hang). Quando isso ocorre, mensagens de erro 17883 aparecem no ERRORLOG para notificar o DBA sobre o problema.</p>  <p>&#160;</p>  <p><strong><font size="3">Como resolver esse tipo de problema?</font></strong></p>  <p>Para determinar a causa do problema, é importante descobrir qual a thread que está monopolizando o Scheduler. O primeiro passo é abrir o arquivo do ERRORLOG para colher as informações iniciais. No exemplo a seguir, a sessão SPID=51 (Thread=0xdbc) monopolizou o Scheduler 1.</p>  <blockquote>   <p><em>Process 51:0:0 (0xdbc) Worker 0x036BA0E8 appears to be non-yielding on Scheduler 1. Thread creation time: 12764721496978. Approx Thread CPU Used: kernel 15 ms, user 171 ms. Process Utilization 0%. System Idle 99%. Interval: 325602683 ms.</em></p> </blockquote>  <p>Para determinar a causa do problema, é imprescindível realizar a análise de memória através de Memory Dump. Um arquivo com extensão MDMP será gerado no diretório de Log e pode ser aberto com o auxílio da ferramenta WinDBG para analisar a CallStack do problema. Exemplos:</p>  <p>&#160;</p>  <p>1) Bug no Stack de I/O (Windows): A causa mais provável é um driver de Disco/Storage</p>  <blockquote>   <p><font face="Courier New"><font color="#ff0000">NTDLL!NtWriteFileGather</font>         <br />KERNEL32!WriteFileGather         <br />ums!UmsScheduler::GatherWriteAsync         <br />sqlservr!UmsGatherWriteAsync         <br />sqlservr!FCB::GatherWrite</font>       <br /></p> </blockquote>  <p>&#160;</p>  <p>2) Antivirus interceptando chamadas do Windows: Interferência no SQL Scheduler</p>  <blockquote>   <p><font face="Courier New">NTDLL!ZwQueryVirtualMemory+0xb        <br />KERNEL32!VirtualQueryEx+0x1b         <br />KERNEL32!VirtualQuery+0x13         <br /></font><font face="Courier New"><font color="#ff0000">MyVirusScanner+0x36c3          <br />MyVirusScanner+0x34d0           <br />MyVirusScanner+0x117e</font>         <br />ADVAPI32!CryptAcquireContextW+0xb8         <br />sqlservr!SecureHash+0x117         <br />sqlservr!FEvalPasswdW+0x35         <br />sqlservr!FCheckPswd+0xe4         <br />sqlservr!FindLogin+0x417         <br />sqlservr!login+0x20f         <br />sqlservr!process_login+0x7d         <br />sqlservr!process_commands+0x201</font> </p> </blockquote>  <p>&#160;</p>  <p>3) Problemas no Buffer Pool (BPool), quando a memória está paginada (PageFile).</p>  <blockquote>   <p><font face="Courier New"><font color="#ff0000">sqlservr!BPool::ReplenishFreeList+0x10d          <br />sqlservr!BPool::Steal+0x3ec</font>         <br />sqlservr!SQLSinglePageAllocator::AllocatePages+0x25         <br />sqlservr!MemoryNode::AllocatePagesInternal+0xce         <br />sqlservr!MemoryClerkInternal::AllocatePages+0x6e         <br />sqlservr!CVarPageMgr::PviNewVarPage+0x56         <br />sqlservr!CVarPageMgr::PbAllocate+0x3ce         <br />sqlservr!CMemObj::Alloc+0xcc         <br />sqlservr!operator new+0x26         <br />sqlservr!operator new[]+0x23         <br />sqlservr!CErrorReportingManager::CwchFormatToBuffer+0x180         <br />sqlservr!CErrorReportingManager::CwchCallFormatToBuffer+0x18         <br />sqlservr!CLoginClientInfo::CLoginClientInfo+0x71         <br />sqlservr!IssueLoginSuccessReport+0x67         <br />sqlservr!login+0x584         <br />sqlservr!process_login+0xee         <br />sqlservr!process_commands+0x40d         <br />sqlservr!SOS_Task::Param::Execute+0xee         <br />sqlservr!SOS_Scheduler::RunTask+0xc9         <br />sqlservr!SOS_Scheduler::ProcessTasks+0xb4</font>       <br /></p> </blockquote>  <p>&#160;</p>  <p><strong><font size="3">Causa do Problema</font></strong></p>  <p>O desenvolvedor é incapaz de escrever uma query em T-SQL que causa problemas no gerenciamento de thread. Travamentos do Scheduler são problemas decorrentes de bug do SQL Server, Windows ou falhas de Hardware. </p>  <p>&#160;</p>  <p><strong><font size="3">Referências</font></strong></p>  <blockquote>   <p>Leivio Fontenele - O que é SQLOS..???      <br /><a title="http://dbaninja.com/?m=201002" href="http://dbaninja.com/?m=201002">http://dbaninja.com/?m=201002</a></p> </blockquote>  <blockquote>   <p>New concurrency and scheduling diagnostics have been added to SQL Server      <br /><a title="http://support.microsoft.com/kb/319892" href="http://support.microsoft.com/kb/319892">http://support.microsoft.com/kb/319892</a></p> </blockquote>  <blockquote>   <p>How To Diagnose and Correct Errors 17883, 17884, 17887, and 17888      <br /><a title="http://technet.microsoft.com/en-us/library/cc917684.aspx" href="http://technet.microsoft.com/en-us/library/cc917684.aspx">http://technet.microsoft.com/en-us/library/cc917684.aspx</a></p></blockquote>
